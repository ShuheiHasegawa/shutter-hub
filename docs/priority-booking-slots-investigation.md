# 優先予約システム実装状況調査（優先チケット配布機能）

調査日: 2025-01-18  
更新日: 2025-11-26

## 📋 調査概要

優先予約システムの実装状況を調査しました。
開発当初の設計方針である「主催者が指定したユーザーに対して、主催者が主催する撮影会だけ優先予約できるチケットを配布する機能」の実装状況を調査しました。

## 🔄 設計変更履歴

### 2025-11-26: VIP/プラチナ/ゴールド枠数設定の廃止

**変更内容**:
- VIP/プラチナ/ゴールド枠数の入力欄を削除
- チケットタイプを1つ（'general'）に統一
- システムを簡素化し、時間ベースの優先予約のみに統一

**理由**:
- 時間ベースの優先予約で十分な機能を提供できる
- 実装・運用コストの削減
- ユーザー体験の簡素化

## ✅ 実装済み項目

### 1. **優先予約設定UI** ✅ 完了

**ファイル**: `src/components/photo-sessions/BookingSettingsForm.tsx`

- 優先予約設定フォーム（`renderPrioritySettings`）が実装済み
- 時間ベースの優先予約設定（予約開始時間）
- 一般予約設定（有効化・開始時間）

**注意**: VIP/プラチナ/ゴールド枠数の入力欄は2025-11-26に削除されました。

### 2. **型定義** ✅ 完了

**ファイル**: `src/types/database.ts`

- `BookingSettings`インターフェースに優先予約設定が定義済み
- `enable_general_booking`, `general_booking_start_time`が定義済み

**注意**: `vip_slots`, `platinum_slots`, `gold_slots`は2025-11-26に削除されました。

### 3. **チケットタイプの統一** ✅ 完了（2025-11-26）

**変更内容**:
- `PriorityTicket`インターフェースの`ticket_type`を`'general'`のみに統一
- データベースの`priority_tickets`テーブルの`ticket_type` CHECK制約を`'general'`のみに更新

**マイグレーション**: `20251126103406_simplify_priority_ticket_system.sql`

## 🎫 優先チケット配布機能の実装状況

### 開発当初の設計方針

**優先チケット機能の設計思想**:
- 主催者が指定したユーザーに対してチケットを配布
- その主催者が主催する**今後のどの撮影会でも使える**
- 使用時に初めて撮影会IDが記録される
- 感謝・招待・特別優遇に使用する

**重要な設計変更（2025-11-26）**:
- `photo_session_id`は配布時はNULL、使用時に設定される
- チケットは主催者（`issued_by`）に紐づく
- 1枚のチケットで主催者の複数の撮影会に使用可能（1回のみ）

### ✅ 実装済み項目

#### 1. **データベーススキーマ** ✅ 完了

**ファイル**: `supabase/migrations/20250805000002_complete_schema.sql`

- `priority_tickets`テーブルが実装済み
- 以下のカラムが定義済み：
  - `photo_session_id`: 使用された撮影会ID（配布時はNULL、使用時に設定）
  - `user_id`: チケットを受け取るユーザーID
  - `issued_by`: チケットを配布した主催者ID（この主催者の撮影会で使用可能）
  - `ticket_type`: チケットタイプ（'general'のみ）
  - `expires_at`: 有効期限
  - `is_active`: アクティブ状態
  - `used_at`: 使用日時
  - `notes`: メモ

**設計修正（2025-11-26）**:
- `photo_session_id`をNULL許可に変更
- UNIQUE制約を削除（主催者ごとのチケット管理に変更）
- `issued_by`インデックスを追加

**実装箇所**: 83-96行目

```sql
CREATE TABLE priority_tickets (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
  photo_session_id UUID REFERENCES photo_sessions(id) ON DELETE CASCADE,
  ticket_type TEXT DEFAULT 'general' CHECK (ticket_type IN ('general', 'vip', 'early_bird', 'special')),
  issued_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
  expires_at TIMESTAMP WITH TIME ZONE,
  used_at TIMESTAMP WITH TIME ZONE,
  is_active BOOLEAN DEFAULT TRUE,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, photo_session_id)
);
```

#### 2. **Server Actions** ✅ 完了

**ファイル**: `src/app/actions/photo-session-priority.ts`

- `createPriorityTicket`: 優先チケット作成（配布）関数 ✅
  - 主催者権限チェック実装済み
  - `priority_tickets`テーブルに保存
  - 実装箇所: 133-175行目

- `getPriorityTickets`: 優先チケット一覧取得関数 ✅
  - 撮影会ごとのチケット一覧を取得
  - ユーザー情報と配布者情報も取得
  - 実装箇所: 177-206行目

#### 3. **型定義** ✅ 完了

**ファイル**: `src/app/actions/photo-session-priority.ts`

- `PriorityTicket`インターフェースが定義済み
- 実装箇所: 26-34行目

```typescript
export interface PriorityTicket {
  id?: string;
  photo_session_id: string;
  user_id: string;
  granted_by: string;
  ticket_type: 'general' | 'vip' | 'special';
  expires_at: string;
  notes?: string;
}
```

#### 4. **チケット使用ロジック** ✅ 部分的に完了

**ファイル**: `src/app/actions/photo-session-priority.ts`

- `createPriorityBooking`関数内でチケット使用処理が実装済み
- `use_priority_ticket` RPC関数を呼び出し（ただし、RPC関数の実装は未確認）
- 実装箇所: 351-370行目

**注意**: `use_priority_ticket` RPC関数はServer Actionから呼び出されているが、マイグレーションファイルに定義が見つからない。実装が必要な可能性が高い。

### ❌ 未実装項目

#### 1. **優先チケット配布UI** ❌ 未実装

**問題点**:
- 主催者がユーザーを選択してチケットを配布するUIコンポーネントが存在しない
- `PriorityBookingSettings.tsx`には設定UIのみ存在
- チケット管理画面（一覧・配布・削除）が未実装

**期待されるコンポーネント**:
- `PriorityTicketManagement.tsx`: 優先チケット管理画面（プロンプトファイルで言及されているが未実装）
- ユーザー検索・選択機能
- チケット配布フォーム
- チケット一覧表示
- チケット削除機能

#### 2. **RPC関数** ❌ 未実装

**問題点**:
- `use_priority_ticket` RPC関数の実装が見つからない
- `check_priority_booking_eligibility` RPC関数の実装が見つからない
- マイグレーションファイルにこれらの関数定義が存在しない

**確認結果**:
- `supabase/migrations/20250805000002_complete_schema.sql`を確認したが、これらのRPC関数は定義されていない
- `calculate_user_rank`関数は存在するが、優先予約関連のRPC関数は未実装
- Server Actionから呼び出されているが、実際の関数が存在しないため、エラーが発生する可能性が高い

**実装が必要なRPC関数**:
1. `check_priority_booking_eligibility`: 優先予約可能性チェック
   - チケット保有状況の確認
   - ユーザーランクの確認
   - 予約開始時間の確認
   - 枠数制限の確認（将来実装）

2. `use_priority_ticket`: チケット使用処理
   - チケットの有効性チェック（有効期限、アクティブ状態）
   - チケットの使用済みマーク
   - エラーハンドリング

#### 3. **チケット配布通知** ❓ 未確認

**問題点**:
- チケット配布時にユーザーに通知を送信する処理が未確認
- チケット有効期限切れ前のリマインダー通知が未確認

## 📊 優先チケット配布機能の実装状況サマリー

| 項目 | 状態 | 備考 |
|------|------|------|
| **データベーススキーマ** | ✅ 完了 | `priority_tickets`テーブル実装済み、設計修正完了 |
| **Server Actions** | ✅ 完了 | `createPriorityTicket`, `getPriorityTicketsByOrganizer`, `deletePriorityTicket`実装済み |
| **型定義** | ✅ 完了 | `PriorityTicket`インターフェース定義済み、設計修正完了 |
| **チケット使用ロジック** | ⚠️ 部分的 | `createPriorityBooking`内で実装済み、RPC関数未実装 |
| **チケット配布UI** | ✅ 完了 | 独立した管理ページ`/priority-tickets`実装済み |
| **RPC関数** | ❌ 未実装 | `use_priority_ticket`, `check_priority_booking_eligibility`が存在しない |
| **通知機能** | ❓ 未確認 | チケット配布・期限切れ通知の実装未確認 |

## 🔧 優先チケット配布機能の必要な実装作業

### 1. **チケット配布UI実装** ✅ 完了（2025-11-26）

**コンポーネント**: `src/components/organizer/PriorityTicketManagement.tsx`

**実装済み機能**:
- ✅ ユーザー検索・選択機能（デバウンス付き）
- ✅ チケット配布フォーム（ユーザー選択、有効期限設定、メモ入力）
- ✅ チケット一覧表示（配布済みチケットの一覧）
- ✅ チケット削除機能（使用済みは削除不可）
- ✅ チケット使用状況表示（有効/使用済み/期限切れ）
- ✅ 統計カード（配布総数、有効、使用済み、期限切れ）

**実装場所**:
- 独立した管理ページ: `/priority-tickets`
- サイドバーの撮影会項目から直接アクセス可能

### 2. **RPC関数の実装** 🔴 必須

**実装が必要な関数**:

#### `check_priority_booking_eligibility` RPC関数

**機能**:
- ユーザーの優先予約可能性をチェック
- チケット保有状況の確認
- ユーザーランクの確認
- 予約開始時間の確認
- 枠数制限の確認（将来実装時）

**パラメータ**:
- `target_photo_session_id`: 撮影会ID
- `target_user_id`: ユーザーID

**戻り値**:
- `can_book`: 予約可能かどうか
- `booking_type`: 予約タイプ（'ticket_priority', 'rank_priority', 'general'）
- `reason`: 理由
- `available_from`: 予約可能開始時刻

#### `use_priority_ticket` RPC関数

**機能**:
- 優先チケットの使用処理
- チケットの有効性チェック（有効期限、アクティブ状態、未使用状態）
- **主催者の確認**（チケットの`issued_by`と撮影会の`organizer_id`が一致するか）
- チケットの使用済みマーク（`used_at`、`photo_session_id`の更新）
- エラーハンドリング

**パラメータ**:
- `target_photo_session_id`: 撮影会ID
- `target_user_id`: ユーザーID

**戻り値**:
- `success`: 成功/失敗
- `message`: メッセージ
- `ticket_id`: 使用したチケットID

**重要なロジック**:
1. ユーザーが保有する有効なチケットを検索
2. チケットの`issued_by`と撮影会の`organizer_id`が一致するか確認
3. 一致する場合のみチケット使用を許可
4. `photo_session_id`と`used_at`を更新

**実装場所**:
- 新しいマイグレーションファイルを作成
- `supabase/migrations/YYYYMMDDHHMMSS_create_priority_booking_rpc_functions.sql`

### 3. **通知機能実装** 🟡 推奨

- チケット配布時の通知送信
- チケット有効期限切れ前のリマインダー通知

## 📝 結論

### VIP/プラチナ/ゴールド枠数機能

**現在の実装状況**: **2025-11-26に廃止されました**。時間ベースの優先予約のみを使用する方針に変更されました。

### 優先チケット配布機能

**現在の実装状況**: データベーススキーマとServer Actionsは実装済みですが、**主催者向けのチケット配布UIが未実装**のため、実際にチケットを配布する機能は使用できない状態です。また、RPC関数の実装状況も確認が必要です。

**優先度**: 🔴 高（優先予約システムの核心機能のため）

**見積時間**: 
- 優先チケット配布UI: UIコンポーネント実装（3-4時間）+ RPC関数実装（2-3時間）+ テスト（1時間） = **合計6-8時間**

**注意**: VIP/プラチナ/ゴールド枠数機能は2025-11-26に廃止されました。

## 📋 実装プラン（開発当初の設計方針に基づく）

### 優先チケット機能の実装方針

**設計思想**:
- 主催者が指定したユーザーに対して
- 主催者が主催する撮影会だけ優先予約できるチケットを配布する
- 感謝・招待・特別優遇に使用する

**実装の優先順位**:

1. **Phase 1: RPC関数実装** 🔴 最優先
   - `check_priority_booking_eligibility` RPC関数の実装
   - `use_priority_ticket` RPC関数の実装
   - これらがないと優先予約機能が動作しない

2. **Phase 2: チケット配布UI実装** 🔴 高優先度
   - 主催者向けチケット管理画面の実装
   - ユーザー検索・選択機能
   - チケット配布フォーム
   - チケット一覧・削除機能

3. **Phase 3: VIP/プラチナ/ゴールド枠数機能** ❌ 廃止（2025-11-26）
   - 時間ベースの優先予約のみを使用する方針に変更
   - 実装不要

4. **Phase 4: 通知機能** 🟢 低優先度
   - チケット配布通知
   - チケット期限切れリマインダー

### 実装時の注意点

1. **チケット配布は撮影会単位**
   - 1つのチケット = 1つの撮影会に対する優先予約権
   - 主催者が主催する撮影会のみ有効

2. **チケットの有効期限管理**
   - `expires_at`で有効期限を設定
   - 期限切れチケットは使用不可

3. **チケットの一意性**
   - `UNIQUE(user_id, photo_session_id)`制約により、1ユーザー1撮影会につき1チケットのみ

4. **チケット使用後の状態管理**
   - `used_at`で使用日時を記録
   - `is_active`でアクティブ状態を管理

## 🤔 VIP/プラチナ/ゴールド枠数を分けるメリット・デメリット分析

### 現在の実装状況

**時間ベースの優先予約** ✅ 実装済み:
- VIP、プラチナ、ゴールド、シルバーそれぞれに予約開始時間を設定可能
- 例：VIPは10:00、プラチナは11:00、ゴールドは12:00、一般は13:00
- 時間が来れば、そのランクのユーザーは予約可能（枠数制限なし）

**枠数制限** ❌ 未実装:
- VIP枠数、プラチナ枠数、ゴールド枠数の入力欄は存在するが、実際の制限機能は未実装
- 時間ベースのみで動作している

### ✅ メリット（枠数を分ける場合）

#### 1. **確実性の保証**
- **高ランクユーザーへの特典**: VIP/プラチナユーザーが確実に予約できる枠を確保できる
- **人気撮影会での優遇**: 人気撮影会でも、高ランクユーザーは枠数が確保されているため予約できる
- **ランクアップのインセンティブ**: ランクが上がることで、より確実に予約できるという明確なメリットを提供

#### 2. **公平性と優遇のバランス**
- **段階的な優遇**: ランクごとに異なる枠数を設定することで、公平性を保ちながらも優遇を提供できる
- **一般ユーザーへの配慮**: 高ランクユーザーに全ての枠を取られないよう、一般枠も確保できる

#### 3. **ビジネス価値**
- **リピーター優遇**: 継続参加者への明確な特典として機能
- **ランクシステムの価値向上**: ランクが上がることで実際のメリット（予約確実性）が得られる

### ❌ デメリット（枠数を分ける場合）

#### 1. **複雑性の増加**
- **実装コスト**: 時間ベースだけでなく、枠数管理のロジックも必要
- **運用コスト**: 主催者が各ランクの枠数を適切に設定する必要がある
- **デバッグの難しさ**: 時間ベースと枠数制限の両方を考慮する必要があり、問題発生時の原因特定が困難

#### 2. **柔軟性の低下**
- **固定化された枠数**: 各ランクの枠数を事前に決める必要があり、需要に応じた柔軟な調整が難しい
- **未使用枠の発生**: 高ランクユーザーが少ない場合、確保した枠が無駄になる可能性がある

#### 3. **ユーザー体験への影響**
- **複雑な理解**: ユーザーが「VIP枠数」「プラチナ枠数」などの概念を理解する必要がある
- **予約失敗の可能性**: 時間内でも枠数が満杯の場合、予約できない（時間ベースのみなら時間内なら予約可能）

### 🔄 代替案の比較

#### 案1: **時間ベースのみ（現在の実装）** ✅ 推奨

**仕組み**:
- 各ランクに予約開始時間を設定
- 時間が来れば、そのランクのユーザーは予約可能（枠数制限なし）
- 先着順で予約が埋まっていく

**メリット**:
- ✅ シンプルで理解しやすい
- ✅ 実装済みで動作している
- ✅ 柔軟性が高い（需要に応じて自然に調整される）
- ✅ 未使用枠の発生がない

**デメリット**:
- ❌ 高ランクユーザーでも、時間内にアクセスしないと予約できない可能性がある
- ❌ 人気撮影会では、高ランクユーザーでも予約できない場合がある

#### 案2: **全体の優先枠数のみ**

**仕組み**:
- 優先予約全体（VIP+プラチナ+ゴールド）で枠数を設定
- 時間ベースで予約開始
- 優先枠が満杯になったら、一般予約に移行

**メリット**:
- ✅ ランク別ではなく、優先予約全体で管理するためシンプル
- ✅ 高ランクユーザーへの優遇は時間ベースで提供
- ✅ 実装コストが低い

**デメリット**:
- ❌ ランク間の差別化が弱い
- ❌ VIPとゴールドが同じ枠を争うことになる

#### 案3: **チケット優先のみ（開発当初の設計方針）**

**仕組み**:
- 主催者が指定したユーザーにチケットを配布
- チケット保有者は優先予約可能
- ランク優先機能は使わない

**メリット**:
- ✅ 最もシンプル
- ✅ 主催者の裁量で柔軟に優遇できる
- ✅ ランクシステムに依存しない

**デメリット**:
- ❌ 自動的な優遇がない（手動配布が必要）
- ❌ ランクシステムの価値が低くなる

### 💡 推奨案

**現時点での推奨**: **時間ベースのみ（案1）を継続**

**理由**:
1. **既に実装済み**: 時間ベースの優先予約は実装済みで動作している
2. **シンプルさ**: ユーザーも主催者も理解しやすい
3. **柔軟性**: 需要に応じて自然に調整される
4. **実装コスト**: 枠数制限機能を実装するコストを他の機能に回せる

**将来的な検討事項**:
- 人気撮影会で高ランクユーザーが予約できない問題が実際に発生した場合
- ランクシステムの価値を高める必要がある場合
- ビジネス要件として確実性の保証が必要になった場合

その際に、VIP/プラチナ/ゴールド枠数を分ける機能を追加することを検討する。

### 📊 判断基準

**枠数を分ける機能を実装すべきか？**

| 判断基準 | 実装すべき | 実装不要 |
|---------|----------|---------|
| **人気撮影会での高ランクユーザー予約失敗が頻発** | ✅ | ❌ |
| **ランクシステムの価値を高める必要がある** | ✅ | ❌ |
| **ビジネス要件として確実性の保証が必要** | ✅ | ❌ |
| **時間ベースのみで十分な機能を提供できている** | ❌ | ✅ |
| **実装コストを他の機能に回したい** | ❌ | ✅ |
| **シンプルさを優先したい** | ❌ | ✅ |

### 🎯 結論

**現時点では、VIP/プラチナ/ゴールド枠数を分ける機能は実装不要と判断**

**理由**:
1. 時間ベースの優先予約で十分な機能を提供できている
2. 実装コストが高い（データベーススキーマ、ビジネスロジック、UI）
3. 複雑性が増す（運用・デバッグ・ユーザー理解）
4. 実際の需要が不明確（問題が発生してから実装しても遅くない）

**推奨アクション**:
1. **現状維持**: 時間ベースの優先予約を継続使用
2. **モニタリング**: 高ランクユーザーの予約成功率を監視
3. **フィードバック収集**: ユーザーから「確実に予約できる枠が欲しい」という要望が出た場合に検討
4. **段階的実装**: まずは「優先予約全体の枠数制限」から始める（案2）ことも検討可能

