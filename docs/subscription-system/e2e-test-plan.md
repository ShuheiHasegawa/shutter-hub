# サブスクリプションシステム E2Eテスト計画

## 📋 テスト項目一覧

### 🎯 **テストカテゴリ1: サブスクリプション作成フロー**

#### **T1-1: 新規サブスクリプション作成（モデル向け）**
```typescript
test('モデル向けベーシックプランの新規作成', async ({ page }) => {
  // 1. サブスクリプションページに移動
  // 2. モデル向けプラン一覧が表示されることを確認
  // 3. ベーシックプランを選択
  // 4. 確認ダイアログが表示されることを確認
  // 5. 確認ボタンをクリック
  // 6. Stripe決済ページにリダイレクトされることを確認
  // 7. Stripe Test Card情報を入力
  // 8. 決済実行
  // 9. 決済完了ページが表示されることを確認
  // 10. サブスクリプション状態が「active」になることを確認
});
```

**検証項目**:
- ✅ プラン一覧が正しく表示される
- ✅ プラン選択が正しく動作する
- ✅ Stripe決済フォームが表示される
- ✅ 決済が成功する
- ✅ サブスクリプションが作成される
- ✅ データベースに正しく記録される

#### **T1-2: 新規サブスクリプション作成（カメラマン向け）**
```typescript
test('カメラマン向けプロプランの新規作成', async ({ page }) => {
  // カメラマン向けプランでの同様のフロー
});
```

#### **T1-3: 新規サブスクリプション作成（運営者向け）**
```typescript
test('運営者向けスタンダードプランの新規作成', async ({ page }) => {
  // 運営者向けプランでの同様のフロー
});
```

#### **T1-4: 決済エラーハンドリング**
```typescript
test('決済失敗時のエラーハンドリング', async ({ page }) => {
  // 1. プラン選択
  // 2. Stripe決済ページに移動
  // 3. 決済失敗カード（4000000000000002）を使用
  // 4. エラーメッセージが表示されることを確認
  // 5. サブスクリプションが作成されていないことを確認
});
```

---

### 🔄 **テストカテゴリ2: プラン変更フロー**

#### **T2-1: プランアップグレード（フリー→有料）**
```typescript
test('フリープランからベーシックプランへのアップグレード', async ({ page }) => {
  // 1. フリープランでログイン
  // 2. サブスクリプションページに移動
  // 3. ベーシックプランを選択
  // 4. 確認ダイアログが表示されることを確認
  // 5. 確認ボタンをクリック
  // 6. Stripe決済ページにリダイレクト
  // 7. 決済実行
  // 8. プラン変更が完了することを確認
  // 9. 新しいプランの機能が利用可能になることを確認
});
```

#### **T2-2: プランアップグレード（有料→上位プラン）**
```typescript
test('ベーシックプランからプレミアムプランへのアップグレード', async ({ page }) => {
  // 1. ベーシックプランでログイン
  // 2. プレミアムプランを選択
  // 3. 日割り計算額が表示されることを確認
  // 4. 確認ボタンをクリック
  // 5. updateSubscriptionが呼ばれることを確認
  // 6. プラン変更が完了することを確認
  // 7. 日割り計算が正しく処理されることを確認
});
```

#### **T2-3: プランダウングレード（有料→下位プラン）**
```typescript
test('プレミアムプランからベーシックプランへのダウングレード', async ({ page }) => {
  // 1. プレミアムプランでログイン
  // 2. ベーシックプランを選択
  // 3. 日割り返金額が表示されることを確認
  // 4. 確認ボタンをクリック
  // 5. プラン変更が完了することを確認
  // 6. 返金が正しく処理されることを確認
});
```

#### **T2-4: プラン変更キャンセル**
```typescript
test('プラン変更確認ダイアログのキャンセル', async ({ page }) => {
  // 1. プラン選択
  // 2. 確認ダイアログが表示される
  // 3. キャンセルボタンをクリック
  // 4. プラン変更が実行されないことを確認
  // 5. 元のプランのままであることを確認
});
```

---

### 🚫 **テストカテゴリ3: 機能制限チェック**

#### **T3-1: フォトブック作成制限チェック（フリープラン）**
```typescript
test('フリープランでのフォトブック作成制限', async ({ page }) => {
  // 1. フリープランでログイン
  // 2. フォトブック作成ページに移動
  // 3. 制限内でフォトブックを作成（成功）
  // 4. 制限数を超えてフォトブックを作成しようとする
  // 5. エラーメッセージが表示されることを確認
  // 6. アップグレード促進UIが表示されることを確認
});
```

#### **T3-2: フォトブック作成制限チェック（有料プラン）**
```typescript
test('有料プランでのフォトブック作成制限', async ({ page }) => {
  // 1. ベーシックプランでログイン
  // 2. 制限内でフォトブックを作成（成功）
  // 3. 制限数を超えてフォトブックを作成しようとする
  // 4. エラーメッセージが表示されることを確認
  // 5. 上位プランへのアップグレード促進UIが表示されることを確認
});
```

#### **T3-3: 撮影会作成制限チェック（運営者）**
```typescript
test('運営者向け撮影会作成制限チェック', async ({ page }) => {
  // 1. 運営者フリープランでログイン
  // 2. 撮影会作成ページに移動
  // 3. 制限内で撮影会を作成（成功）
  // 4. 制限数を超えて撮影会を作成しようとする
  // 5. エラーメッセージが表示されることを確認
  // 6. アップグレード促進UIが表示されることを確認
});
```

#### **T3-4: ユーザータイプ別機能制限（モデル）**
```typescript
test('モデル向け機能制限チェック', async ({ page }) => {
  // 1. モデルフリープランでログイン
  // 2. プレミアムテンプレート機能にアクセス
  // 3. FeatureGateが表示されることを確認
  // 4. アップグレードボタンが表示されることを確認
  // 5. ベーシックプランにアップグレード
  // 6. プレミアムテンプレート機能が利用可能になることを確認
});
```

#### **T3-5: ユーザータイプ別機能制限（カメラマン）**
```typescript
test('カメラマン向け機能制限チェック', async ({ page }) => {
  // 1. カメラマンフリープランでログイン
  // 2. 透かし除去機能にアクセス
  // 3. FeatureGateが表示されることを確認
  // 4. プロプランにアップグレード
  // 5. 透かし除去機能が利用可能になることを確認
});
```

#### **T3-6: ユーザータイプ別機能制限（運営者）**
```typescript
test('運営者向け機能制限チェック', async ({ page }) => {
  // 1. 運営者フリープランでログイン
  // 2. 高度な分析機能にアクセス
  // 3. FeatureGateが表示されることを確認
  // 4. スタンダードプランにアップグレード
  // 5. 高度な分析機能が利用可能になることを確認
});
```

---

### 🔔 **テストカテゴリ4: サブスクリプション状態管理**

#### **T4-1: サブスクリプション状態表示**
```typescript
test('現在のサブスクリプション状態表示', async ({ page }) => {
  // 1. 有料プランでログイン
  // 2. サブスクリプションページに移動
  // 3. SubscriptionStatusコンポーネントが表示されることを確認
  // 4. プラン名、料金、次回請求日が正しく表示されることを確認
  // 5. ステータスが「active」であることを確認
});
```

#### **T4-2: サブスクリプションキャンセル**
```typescript
test('サブスクリプションキャンセル', async ({ page }) => {
  // 1. 有料プランでログイン
  // 2. サブスクリプションページに移動
  // 3. キャンセルボタンをクリック
  // 4. 確認ダイアログが表示されることを確認
  // 5. キャンセル確認ボタンをクリック
  // 6. サブスクリプションがキャンセルされることを確認
  // 7. ステータスが「canceled」または「cancel_at_period_end」になることを確認
});
```

#### **T4-3: サブスクリプション再開**
```typescript
test('キャンセル済みサブスクリプションの再開', async ({ page }) => {
  // 1. キャンセル済みサブスクリプションでログイン
  // 2. サブスクリプションページに移動
  // 3. 再開ボタンが表示されることを確認
  // 4. 再開ボタンをクリック
  // 5. サブスクリプションが再開されることを確認
  // 6. ステータスが「active」になることを確認
});
```

---

### 🔄 **テストカテゴリ5: Webhook処理（統合テスト）**

#### **T5-1: Stripe Webhook処理（サブスクリプション作成）**
```typescript
test('Stripe Webhook: サブスクリプション作成', async ({ page }) => {
  // 注意: これはE2Eテストではなく、統合テストとして実装
  // 1. サブスクリプションを作成
  // 2. Stripe Webhookをシミュレート
  // 3. customer.subscription.createdイベントを送信
  // 4. データベースが正しく更新されることを確認
});
```

#### **T5-2: Stripe Webhook処理（プラン変更）**
```typescript
test('Stripe Webhook: プラン変更', async ({ page }) => {
  // 1. プラン変更を実行
  // 2. Stripe Webhookをシミュレート
  // 3. customer.subscription.updatedイベントを送信
  // 4. データベースのplan_idが正しく更新されることを確認
});
```

---

### 🎨 **テストカテゴリ6: UI/UXテスト**

#### **T6-1: プラン選択UI表示**
```typescript
test('プラン選択UIの表示確認', async ({ page }) => {
  // 1. サブスクリプションページに移動
  // 2. プランカードが正しく表示されることを確認
  // 3. 現在のプランがハイライトされていることを確認
  // 4. 機能リストが正しく表示されることを確認
  // 5. 価格が正しく表示されることを確認
});
```

#### **T6-2: FeatureGateコンポーネント表示**
```typescript
test('FeatureGateコンポーネントの表示確認', async ({ page }) => {
  // 1. フリープランでログイン
  // 2. プレミアム機能にアクセス
  // 3. FeatureGateが表示されることを確認
  // 4. ロックアイコンが表示されることを確認
  // 5. アップグレードボタンが表示されることを確認
  // 6. 現在のプラン名と必要なプラン名が表示されることを確認
});
```

#### **T6-3: レスポンシブデザインテスト**
```typescript
test('サブスクリプションページのレスポンシブデザイン', async ({ page }) => {
  // 1. モバイルビューポートで表示
  // 2. プランカードが正しく表示されることを確認
  // 3. タブレットビューポートで表示
  // 4. デスクトップビューポートで表示
  // 5. 各ビューポートでレイアウトが崩れていないことを確認
});
```

---

## 📊 テスト実装優先度

### **優先度1（必須）**
- T1-1: 新規サブスクリプション作成（モデル向け）
- T1-4: 決済エラーハンドリング
- T2-1: プランアップグレード（フリー→有料）
- T3-1: フォトブック作成制限チェック（フリープラン）
- T3-3: 撮影会作成制限チェック（運営者）
- T4-1: サブスクリプション状態表示

### **優先度2（重要）**
- T2-2: プランアップグレード（有料→上位プラン）
- T2-3: プランダウングレード
- T3-2: フォトブック作成制限チェック（有料プラン）
- T3-4: ユーザータイプ別機能制限（モデル）
- T4-2: サブスクリプションキャンセル

### **優先度3（推奨）**
- T1-2: 新規サブスクリプション作成（カメラマン向け）
- T1-3: 新規サブスクリプション作成（運営者向け）
- T2-4: プラン変更キャンセル
- T3-5: ユーザータイプ別機能制限（カメラマン）
- T3-6: ユーザータイプ別機能制限（運営者）
- T4-3: サブスクリプション再開
- T6-1: プラン選択UI表示
- T6-2: FeatureGateコンポーネント表示
- T6-3: レスポンシブデザインテスト

### **優先度4（将来実装）**
- T5-1: Stripe Webhook処理（サブスクリプション作成）
- T5-2: Stripe Webhook処理（プラン変更）

---

## 🛠️ 実装方針

### **テストファイル構成**
```
tests/e2e/
├── subscription/
│   ├── subscription-creation.spec.ts      # カテゴリ1: サブスクリプション作成
│   ├── plan-change.spec.ts                # カテゴリ2: プラン変更
│   ├── feature-limits.spec.ts             # カテゴリ3: 機能制限チェック
│   ├── subscription-status.spec.ts        # カテゴリ4: 状態管理
│   └── subscription-ui.spec.ts            # カテゴリ6: UI/UXテスト
└── utils/
    └── subscription-helpers.ts             # サブスクリプション関連ヘルパー関数
```

### **テストヘルパー関数**
```typescript
// tests/e2e/utils/subscription-helpers.ts
export async function selectPlan(page: Page, planId: string);
export async function fillStripePaymentForm(page: Page, cardNumber: string);
export async function verifySubscriptionStatus(page: Page, expectedStatus: string);
export async function checkFeatureLimit(page: Page, featureName: string);
export async function upgradePlan(page: Page, newPlanId: string);
```

### **テストデータ**
- テスト用ユーザー（モデル、カメラマン、運営者）
- テスト用Stripe Test Cards
- テスト用プランID

---

## 📝 実装チェックリスト

### **Phase 1: 基本フローテスト（優先度1）**
- [ ] T1-1: 新規サブスクリプション作成（モデル向け）
- [ ] T1-4: 決済エラーハンドリング
- [ ] T2-1: プランアップグレード（フリー→有料）
- [ ] T3-1: フォトブック作成制限チェック
- [ ] T3-3: 撮影会作成制限チェック
- [ ] T4-1: サブスクリプション状態表示

### **Phase 2: 拡張テスト（優先度2）**
- [ ] T2-2: プランアップグレード（有料→上位）
- [ ] T2-3: プランダウングレード
- [ ] T3-2: フォトブック作成制限（有料プラン）
- [ ] T3-4: ユーザータイプ別機能制限（モデル）
- [ ] T4-2: サブスクリプションキャンセル

### **Phase 3: 完全テスト（優先度3）**
- [ ] 残りのテスト項目

---

## 🎯 期待される成果

1. **品質保証**: サブスクリプションシステムの主要フローが正しく動作することを保証
2. **回帰テスト**: 将来の変更時に既存機能が壊れていないことを確認
3. **ドキュメント**: テストコードがシステムの使用方法を示す
4. **信頼性**: 本番環境での問題を事前に発見

---

**最終更新**: 2025-11-06  
**ステータス**: 計画完了・実装準備中

