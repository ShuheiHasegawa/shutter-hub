# 画像管理構造の調査結果

## 概要

ShutterHubにおける画像管理の現状と、スタジオ・撮影会それぞれの最適な管理方式について調査した結果をまとめます。

## 現状の画像管理構造

### スタジオ (studios)

**管理方式**: 別テーブル `studio_photos` で管理

```typescript
// studio_photos テーブル
{
  id: string;
  studio_id: string;
  image_url: string;
  image_filename?: string;
  alt_text?: string;
  caption?: string;
  category?: StudioPhotoCategory; // exterior, interior, equipment, etc.
  photo_type?: string;
  display_order: number;
  uploaded_by?: string;
  created_at: string;
}
```

**特徴**:
- 正規化されたデータ構造
- 画像ごとのメタデータ管理が可能
- `studio_id`にインデックスを張れるため、検索が高速
- 画像の順序変更・個別削除が効率的
- RLSポリシーを画像単位で適用可能

### 撮影会 (photo_sessions)

**管理方式**: 配列カラム `image_urls: TEXT[]` で管理

```typescript
// photo_sessions テーブル
{
  id: string;
  // ... その他のフィールド
  image_urls: string[] | null; // 撮影会のメイン画像（配列）
}
```

**特徴**:
- シンプルなクエリ（JOIN不要）
- 1回のクエリで撮影会と画像URLを取得
- 画像メタデータ（alt_text, caption等）を保存できない
- 画像の順序変更や個別削除が配列操作になる
- インデックスが効かない（配列内の検索が非効率）

### スロット衣装画像 (photo_session_slots)

**管理方式**: 単一カラム + ハッシュ値で管理

```typescript
// photo_session_slots テーブル
{
  id: string;
  photo_session_id: string;
  // ... その他のフィールド
  costume_image_url?: string;      // 衣装画像URL（単一）
  costume_image_hash?: string;     // 画像のハッシュ値（重複排除用）
  costume_description?: string;     // 衣装の説明
}
```

**特徴**:
- 各スロットに1つの衣装画像のみ
- ハッシュ値による重複排除機能あり
- メタデータ（説明）も保存可能

## パフォーマンス比較（データ量増加時）

| 観点 | 配列方式（撮影会） | 別テーブル方式（スタジオ） |
|------|-------------------|---------------------------|
| 一覧取得 | レコードサイズ増大で遅延 | JOINコストのみ（安定） |
| 画像検索 | インデックス不可 | インデックス可（高速） |
| 個別更新 | 配列全体を更新 | 該当行のみ更新 |
| スケーラビリティ | 低い | 高い |
| メタデータ管理 | 不可 | 可能 |

## 別テーブル化の判断基準

### スタジオの場合

**別テーブル化が推奨される理由**:
1. **コミュニティ編集**: スタジオ情報は誰でも編集可能なWiki形式
2. **継続的な更新**: 画像の追加・削除・順序変更が頻繁に発生
3. **メタデータの重要性**: alt_text, caption, category などの情報が必要
4. **検索要件**: 画像カテゴリや特徴での検索が将来必要になる可能性
5. **スケーラビリティ**: スタジオ数が増えても安定したパフォーマンスが必要

### 撮影会の場合

**現時点では別テーブル化不要と判断**:

| 観点 | 撮影会メイン画像 | スロット衣装画像 |
|------|-----------------|------------------|
| 画像数 | 複数（5枚程度） | 単一 |
| メタデータ | なし | ハッシュ＋説明あり |
| 変更頻度 | 低い（作成時のみ） | 低い（作成時のみ） |
| 検索要件 | なし | なし |
| スケール | 撮影会数に比例 | スロット数に比例 |

**判断理由**:
1. **作成時のみ設定**: 撮影会とスロットの画像は作成者が一度設定したら変更されることが少ない
2. **既存の衣装画像設計**: `costume_image_hash`による重複排除が既に実装されており、効率的な管理がされている
3. **移行コスト**: 既存データのマイグレーションが必要になり、関連する多くのコンポーネントに影響がある
4. **スロット単位の単一画像**: 各スロットに1つの衣装画像のみなので、配列の問題（インデックス不可）が発生しない

## 将来的な別テーブル化を検討すべきケース

以下の要件が発生した場合、撮影会の画像管理も別テーブル化を検討すべき：

1. **メタデータの必要性**: 撮影会メイン画像に alt_text, caption などが必要になった場合
2. **カテゴリ分類**: 画像のカテゴリ分類（外観、内装、モデル例など）が必要になった場合
3. **頻繁な順序変更**: 画像の順序変更機能を頻繁に使う運用になった場合
4. **画像検索機能**: 特定の画像を持つ撮影会を検索する機能が必要になった場合
5. **パフォーマンス問題**: 配列方式によるパフォーマンス問題が実際に発生した場合

## 推奨事項

### 現時点での推奨

- **スタジオ**: 別テーブル方式を継続（既に実装済み）
- **撮影会**: 配列方式を継続（現状で問題なし）

### 実装時の注意点

1. **スタジオ作成時の画像アップロード**: 一時アップロード方式を採用し、スタジオ作成成功後に `studio_photos` レコードを作成
2. **撮影会作成時の画像アップロード**: 既存の `image_urls` 配列方式を継続
3. **スロット衣装画像**: 既存の `costume_image_url` + `costume_image_hash` 方式を継続

### パフォーマンス最適化

- **スタジオ**: `studio_id` にインデックスを張る（既に実装済み）
- **撮影会**: 画像数が増える場合は、配列サイズの上限を設定（例: 最大5枚）
- **スロット**: ハッシュ値による重複排除を活用し、ストレージ使用量を削減

## 参考資料

- [スタジオ作成画像アップロード実装計画](../.cursor/plans/スタジオ作成画像アップロード_9ce1d70e.plan.md)
- `src/types/database.ts` - データベース型定義
- `src/lib/storage/studio-images.ts` - スタジオ画像アップロード実装
- `supabase/migrations/` - データベーススキーマ定義
