# 先着順予約テスト網羅仕様書

## 概要

撮影会予約システムの先着順予約（`first_come`）について、最低限必要なテスト項目を網羅的にまとめた仕様書です。

## テスト対象

- **予約タイプ**: 先着順（`first_come`）
- **撮影会タイプ**: 個別撮影会（`individual`）、合同撮影会（`joint`）
- **権限**: モデル、カメラマン、運営

## テストアカウント

- **モデル**: 小日向ゆか
- **カメラマン**: ishushushu
- **運営**: ことり撮影会

## 関連ファイル

- `src/components/photo-sessions/PhotoSessionBookingForm.tsx` - 予約フォームコンポーネント
- `src/app/actions/photo-session-booking.ts` - 予約作成・キャンセルアクション
- `src/app/actions/photo-session.ts` - `canJoinPhotoSessionAction`（参加可能性チェック）
- `tests/e2e/booking-systems.spec.ts` - 既存E2Eテスト
- `tests/e2e/utils/booking-test-helpers.ts` - 予約テストヘルパー関数

---

## 1. テストマトリクス（全体像）

### 1.1 権限 × 撮影会タイプ × アクション

| 権限 | 撮影会タイプ | 作成 | 予約 | キャンセル | 備考 |
|------|--------------|------|------|------------|------|
| モデル | 個別 | ✅ 可 | ✅ 可（他者主催のみ） | ✅ 可 | 自分が主催した撮影会には予約不可 |
| モデル | 合同 | ❌ 不可 | ✅ 可（他者主催のみ） | ✅ 可 | 運営のみ作成可能 |
| カメラマン | 個別 | ✅ 可 | ✅ 可（他者主催のみ） | ✅ 可 | 自分が主催した撮影会には予約不可 |
| カメラマン | 合同 | ❌ 不可 | ✅ 可（他者主催のみ） | ✅ 可 | 運営のみ作成可能 |
| 運営 | 個別 | ✅ 可 | ✅ 可（他者主催のみ） | ✅ 可 | 自分が主催した撮影会には予約不可 |
| 運営 | 合同 | ✅ 可 | ✅ 可（他者主催のみ） | ✅ 可 | 自分が主催した撮影会には予約不可 |

### 1.2 撮影会タイプの違い
- そもそも撮影会作成ボタン押下時、運営アカウントのみ撮影会のタイプを選択できる画面を表示するようにしている
  - http://localhost:8888/ja/photo-sessions/create/organizer

| 項目 | 個別撮影会（individual） | 合同撮影会（joint） |
|------|-------------------------|---------------------|
| 作成権限 | 全権限で作成可能 | 運営のみ作成可能 |
| 予約単位 | スロット単位（時間枠ごと） | 撮影会全体 |
| 料金設定 | 各モデルに別の料金設定可能 | 複数モデルでも同様の料金設定 |
| 撮影形態 | 各モデル個別に撮影 | 複数モデルに対してカメラマンがバラバラに囲み撮影 |

---

## 2. 正常系テストケース

### 2.1 予約成功パターン

#### TC-N-01: 未ログイン → ログイン → 予約（導線確認）

**Given**: 未ログイン状態で撮影会詳細ページを表示

**When**: 
1. 予約ボタンをクリック
2. ログインページに遷移
3. ログインを実行
4. 撮影会詳細ページに戻る
5. 予約ボタンをクリック
6. 確認ダイアログで確定

**Then**: 
- 予約が成功する
- 「予約が完了しました」のトーストが表示される
- 参加者数が1増える
- 予約確認通知が送信される

**観点**: 認証フローの確認

---

#### TC-N-02: モデルが他者主催の個別撮影会に予約（スロット単位）

**Given**: 
- モデル（小日向ゆか）でログイン済み
- 運営が主催する個別撮影会（先着順、定員5名、参加者0名）が存在
- スロットが設定されている

**When**: 
1. 撮影会詳細ページにアクセス
2. 希望するスロットを選択
3. 予約ボタンをクリック
4. 確認ダイアログで確定

**Then**: 
- 予約が成功する
- 選択したスロットの予約が確定する
- スロットの参加者数が1増える
- 撮影会全体の参加者数が1増える

**観点**: 個別撮影会のスロット予約機能

---

#### TC-N-03: カメラマンが他者主催の合同撮影会に予約

**Given**: 
- カメラマン（ishushushu）でログイン済み
- 運営が主催する合同撮影会（先着順、定員10名、参加者3名）が存在

**When**: 
1. 撮影会詳細ページにアクセス
2. 予約ボタンをクリック
3. 確認ダイアログで確定

**Then**: 
- 予約が成功する
- 撮影会全体の参加者数が4名になる
- 予約確認通知が送信される

**観点**: 合同撮影会の予約機能

---

#### TC-N-04: 各権限での他者主催撮影会への予約

**Given**: 各権限（モデル、カメラマン、運営）でログイン済み

**When**: 他者が主催する撮影会に予約を実行

**Then**: 
- すべての権限で予約が成功する
- 予約確認通知が送信される

**観点**: 権限による予約制限の確認（他者主催は全権限で予約可能）

---

#### TC-N-05: 予約確認通知の送信

**Given**: 予約が成功した

**When**: 通知システムを確認

**Then**: 
- 予約者に「予約が完了しました」通知が送信される
- 主催者に「新しい予約がありました」通知が送信される
- 通知のリンクから撮影会詳細ページに遷移できる

**観点**: 通知システムの動作確認

---

### 2.2 予約キャンセルパターン

#### TC-N-06: 予約者本人によるキャンセル

**Given**: 
- ユーザーが予約済みの撮影会が存在
- 予約一覧ページにアクセス

**When**: 
1. 予約一覧から該当予約を選択
2. キャンセルボタンをクリック
3. 確認ダイアログで確定

**Then**: 
- キャンセルが成功する
- 予約ステータスが「cancelled」になる
- 撮影会の参加者数が1減る
- キャンセル通知が送信される

**観点**: キャンセル機能の基本動作

---

#### TC-N-07: キャンセル後の在庫復元

**Given**: 
- 満席の撮影会（定員5名、参加者5名）
- ユーザーが予約済み

**When**: 予約をキャンセルする

**Then**: 
- 撮影会の参加者数が4名になる
- 在庫が1名分復元される
- 他のユーザーが予約可能になる

**観点**: 在庫管理の正確性

---

#### TC-N-08: キャンセル通知の送信

**Given**: 予約をキャンセルした

**When**: 通知システムを確認

**Then**: 
- 予約者に「予約をキャンセルしました」通知が送信される
- 主催者に「予約がキャンセルされました」通知が送信される

**観点**: キャンセル時の通知システム

---

## 3. 異常系テストケース

### 3.1 認証エラー

#### TC-A-01: 未ログイン状態で予約ボタン押下

**Given**: 未ログイン状態で撮影会詳細ページを表示

**When**: 予約ボタンをクリック

**Then**: 
- ログイン促進メッセージが表示される
- 「ログインしてください」ボタンが表示される
- 予約ボタンは無効化されている

**観点**: 認証必須の確認

**分類**: 認証

---

### 3.2 権限エラー

#### TC-A-02: 自分が主催した撮影会に予約

**Given**: 
- ユーザーが主催する撮影会が存在
- そのユーザーでログイン済み

**When**: 自分が主催した撮影会の詳細ページで予約を試みる

**Then**: 
- 予約ボタンが表示されない、または無効化されている
- 「自分が主催した撮影会には予約できません」というメッセージが表示される
- 予約が実行されない

**観点**: 自己予約制限の確認

**分類**: 権限

**注意**: 現在の実装では `canJoinPhotoSessionAction` にこのチェックがないため、実装が必要な可能性があります。

---

### 3.3 在庫エラー

#### TC-A-03: 満席の撮影会に予約

**Given**: 
- 満席の撮影会（定員5名、参加者5名）が存在
- ユーザーでログイン済み

**When**: 予約ボタンをクリック

**Then**: 
- 予約ボタンが無効化されている
- 「この撮影会は満席です」というメッセージが表示される
- 予約が実行されない

**観点**: 満席時の制御

**分類**: 在庫

---

#### TC-A-04: 既に予約済みの撮影会に再予約

**Given**: 
- ユーザーが既に予約済みの撮影会が存在
- そのユーザーでログイン済み

**When**: 同じ撮影会の詳細ページで予約を試みる

**Then**: 
- 予約ボタンが表示されない、または無効化されている
- 「既に予約済みです」というメッセージが表示される
- 予約が実行されない

**観点**: 重複予約の防止

**分類**: 重複

---

### 3.4 時間エラー

#### TC-A-05: 開始済み撮影会に予約

**Given**: 
- 開始時刻を過ぎた撮影会が存在（開始時刻: 1時間前、終了時刻: 1時間後）
- ユーザーでログイン済み

**When**: 予約ボタンをクリック

**Then**: 
- 予約ボタンが無効化されている
- 「この撮影会は既に開始または終了しています」というメッセージが表示される
- 予約が実行されない

**観点**: 開始時刻チェック

**分類**: 時間

---

#### TC-A-06: 終了済み撮影会に予約

**Given**: 
- 終了時刻を過ぎた撮影会が存在（終了時刻: 1時間前）
- ユーザーでログイン済み

**When**: 予約ボタンをクリック

**Then**: 
- 予約ボタンが無効化されている
- 「この撮影会は既に開始または終了しています」というメッセージが表示される
- 予約が実行されない

**観点**: 終了時刻チェック

**分類**: 時間

---

### 3.5 公開状態エラー

#### TC-A-07: 非公開撮影会に予約

**Given**: 
- 非公開（`is_published = false`）の撮影会が存在
- ユーザーでログイン済み

**When**: 撮影会詳細ページにアクセス（URL直接入力など）

**Then**: 
- 予約ボタンが表示されない、または無効化されている
- 「この撮影会は公開されていません」というメッセージが表示される
- 予約が実行されない

**観点**: 公開状態チェック

**分類**: 公開状態

---

### 3.6 競合エラー

#### TC-A-08: 定員1名 → 同時に2人が予約（競合状態）

**Given**: 
- 定員1名の撮影会（参加者0名）が存在
- 2人のユーザーが同時に予約を試みる

**When**: 
1. ユーザーAとユーザーBが同時に予約ボタンをクリック
2. 両方のリクエストがサーバーに送信される

**Then**: 
- 1人の予約が成功する
- もう1人の予約が失敗する（「満席です」エラー）
- 在庫が正確に管理される（参加者数が1名になる）

**観点**: 同時アクセス時の競合制御

**分類**: 競合

---

## 4. 境界値テストケース

### 4.1 定員・参加者数の境界値

#### TC-BV-01: 定員1名、参加者0名 → 予約

**Given**: 
- 定員1名、参加者0名の撮影会が存在
- ユーザーでログイン済み

**When**: 予約を実行する

**Then**: 
- 予約が成功する
- 参加者数が1/1になる
- 満席表示になる

**観点**: 最小定員での予約

**分類**: 境界値（定員最小値）

---

#### TC-BV-02: 定員10名、参加者9名 → 予約

**Given**: 
- 定員10名、参加者9名の撮影会が存在
- ユーザーでログイン済み

**When**: 予約を実行する

**Then**: 
- 予約が成功する
- 参加者数が10/10になる
- 満席表示になる

**観点**: 満席直前での予約

**分類**: 境界値（満席直前）

---

#### TC-BV-03: 定員10名、参加者10名 → 予約

**Given**: 
- 定員10名、参加者10名の撮影会が存在（満席）
- ユーザーでログイン済み

**When**: 予約を試みる

**Then**: 
- 予約が失敗する
- 「この撮影会は満席です」エラーが表示される

**観点**: 満席時の予約拒否

**分類**: 境界値（満席時）

---

#### TC-BV-04: 定員0名の撮影会（異常値）

**Given**: 
- 定員0名の撮影会が存在（データ不整合）

**When**: 予約を試みる

**Then**: 
- 予約が失敗する
- 適切なエラーメッセージが表示される

**観点**: 異常値のハンドリング

**分類**: 境界値（異常値）

---

### 4.2 時間の境界値

#### TC-BV-05: 開始1分前に予約

**Given**: 
- 開始時刻が1分後の撮影会が存在
- ユーザーでログイン済み

**When**: 予約を実行する

**Then**: 
- 予約が成功する
- 開始時刻直前でも予約可能であることを確認

**観点**: 開始時刻直前の予約

**分類**: 境界値（時間）

---

#### TC-BV-06: 開始時刻ちょうどに予約

**Given**: 
- 開始時刻が現在時刻と一致する撮影会が存在
- ユーザーでログイン済み

**When**: 予約を試みる

**Then**: 
- 予約が失敗する
- 「この撮影会は既に開始または終了しています」エラーが表示される

**観点**: 開始時刻ちょうどの予約拒否

**分類**: 境界値（時間）

---

#### TC-BV-07: 開始1秒前に予約

**Given**: 
- 開始時刻が1秒後の撮影会が存在
- ユーザーでログイン済み

**When**: 予約を実行する

**Then**: 
- 予約が成功する（または失敗する）
- システムの動作が一貫していることを確認

**観点**: 秒単位の時間チェック

**分類**: 境界値（時間）

---

### 4.3 料金の境界値

#### TC-BV-08: 料金0円の撮影会予約

**Given**: 
- 料金0円（無料）の撮影会が存在
- ユーザーでログイン済み

**When**: 予約を実行する

**Then**: 
- 予約が成功する
- 「無料」と表示される
- 決済処理がスキップされる

**観点**: 無料撮影会の予約

**分類**: 境界値（料金）

---

#### TC-BV-09: 料金が非常に高い撮影会（例: 100万円）

**Given**: 
- 料金100万円の撮影会が存在
- ユーザーでログイン済み

**When**: 予約を実行する

**Then**: 
- 予約が成功する（決済処理が正常に動作する）
- 料金が正確に表示される

**観点**: 高額料金の処理

**分類**: 境界値（料金）

---

## 5. 実装確認が必要な項目

### 5.1 自己予約制限

**現状**: `canJoinPhotoSessionAction` に `organizer_id === user_id` のチェックがない

**確認が必要な箇所**:
1. `src/app/actions/photo-session.ts` の `canJoinPhotoSessionAction` 関数
2. DB関数（RPC）`create_photo_session_booking` の実装
3. フロントエンド（`PhotoSessionBookingForm.tsx`）でのボタン表示制御

**推奨実装箇所**: `canJoinPhotoSessionAction` に以下を追加

```typescript
// 自己予約制限チェック
if (session.organizer_id === userId) {
  return { canJoin: false, reason: '自分が主催した撮影会には予約できません' };
}
```

---

## 6. テスト実行方法

### 6.1 実行コマンド

```bash
# 先着順予約のE2Eテストを実行
npx playwright test tests/e2e/booking-systems.spec.ts --grep "先着順"

# 特定のテストケースを実行
npx playwright test tests/e2e/booking-systems.spec.ts -g "TC-N-01"

# UIモードで実行（デバッグ用）
npx playwright test tests/e2e/booking-systems.spec.ts --ui
```

### 6.2 カバレッジ確認

```bash
# テスト実行後にカバレッジを確認
npx playwright test --coverage
```

### 6.3 テストデータの準備

各テストケース実行前に以下を準備:
- テスト用の撮影会データ（個別/合同、各種定員・参加者数）
- テストアカウントの認証状態
- 必要に応じて既存予約データのクリーンアップ

---

## 7. 今後の拡張（Phase 2以降）

### 7.1 抽選予約（lottery）

- 応募期間の設定
- 抽選エントリー
- 抽選実行
- 当選・落選結果の確認
- 通知システム

### 7.2 管理抽選（admin_lottery）

- 応募期間の設定
- 応募エントリー
- 運営による手動選出
- 選出結果の確認
- 通知システム

### 7.3 優先予約（priority）

- ランク別時間帯設定
- 優先チケットの配布
- 段階的予約開始
- ランク別アクセス制御

### 7.4 キャンセル待ち

- キャンセル待ち登録
- 自動繰り上げ処理
- 期限付き繰り上げ当選
- 通知システム

---

## 8. テスト観点まとめ

### 8.1 等価分割

| 観点 | 正常系 | 異常系 |
|------|--------|--------|
| 認証状態 | ログイン済み | 未ログイン |
| 権限 | モデル、カメラマン、運営 | 自分が主催した撮影会 |
| 在庫状態 | 空きあり | 満席、既に予約済み |
| 時間状態 | 開始前 | 開始済み、終了済み |
| 公開状態 | 公開済み | 非公開 |
| 撮影会タイプ | 個別、合同 | - |

### 8.2 境界値

| 項目 | 境界値 |
|------|--------|
| 定員 | 0、1、満席直前、満席 |
| 参加者数 | 0、1、満席直前、満席 |
| 時間 | 開始1分前、開始時刻ちょうど、開始1秒前 |
| 料金 | 0円、高額（100万円） |

---

## 9. 参考資料

- [E2Eテストガイド](../e2e-testing-guide.md)
- [テストコード生成ルール](../../.cursor/rules/dev-rules/test-code-generation.mdc)
- [テスト戦略ルール](../../.cursor/rules/test-strategy.mdc)
