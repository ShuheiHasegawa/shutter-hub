# 入力検証監査レポート

## 監査日時
2025-01-XX

## 概要
ShutterHub の入力検証（Zodスキーマ、XSS対策、SQLインジェクション対策）の全面監査を実施しました。

## 1. Zodスキーマの使用状況

### 1.1 使用されているフォーム

以下のフォームでZodスキーマが使用されています：

#### ✅ スタジオ関連
- `StudioCreateForm` - `formSchema` 使用
- `StudioEditForm` - `formSchema` 使用

#### ✅ プロフィール関連
- `ProfileForm` - `profileFormSchema` 使用
- `ProfileEditForm` - `profileEditSchema` 使用

#### ✅ 認証関連
- `EmailSignUpForm` - `signUpSchema` 使用

#### ✅ 法的文書関連
- `GdprRequestForm` - `gdprRequestSchema` 使用

#### ✅ フォトブック関連
- `QuickPhotobookCreateForm` - `createPhotobookSchema` 使用
- `QuickPhotobookSettings` - `settingsSchema` 使用

### 1.2 バリデーション内容

#### 文字列長制限
- ✅ スタジオ名: 最小1文字、最大100文字
- ✅ 説明: 最大500文字
- ✅ 住所: 最小1文字、最大200文字
- ✅ プロフィール表示名: 最小1文字、最大50文字
- ✅ 自己紹介: 最大500文字

#### データ型検証
- ✅ メールアドレス: `z.string().email()` 使用
- ✅ URL: `z.string().url()` 使用
- ✅ 電話番号: 正規表現パターンで検証
- ✅ 数値: `z.coerce.number()` 使用

#### 必須フィールド
- ✅ 必須フィールドは `.min(1)` または `.min(VALIDATION.xxx.minLength)` で検証

### 1.3 評価

**総合評価**: ✅ **良好**

- 主要なフォームでZodスキーマが使用されています
- 文字列長制限、データ型検証、必須フィールドチェックが適切に実装されています
- React Hook Formと統合されており、クライアント側とサーバー側の両方で検証可能です

## 2. XSS（Cross-Site Scripting）対策

### 2.1 Next.jsの自動エスケープ

Next.jsはデフォルトで自動的にHTMLエスケープを行います。

**評価**: ✅ **適切**

### 2.2 `dangerouslySetInnerHTML` の使用

以下の箇所で `dangerouslySetInnerHTML` が使用されています：

#### ⚠️ 要確認
1. **`src/components/social/PostCard.tsx`** (line 377)
   - 用途: SNS投稿のコンテンツ表示
   - リスク: 中（ユーザー入力データの可能性）
   - 推奨: サニタイズ処理の追加

2. **`src/app/[locale]/legal/terms/page.tsx`** (line 109)
   - 用途: 利用規約の表示
   - リスク: 低（管理者が管理する静的コンテンツ）
   - 推奨: サニタイズ処理の追加（念のため）

3. **`src/app/[locale]/legal/privacy/page.tsx`** (line 206)
   - 用途: プライバシーポリシーの表示
   - リスク: 低（管理者が管理する静的コンテンツ）
   - 推奨: サニタイズ処理の追加（念のため）

### 2.3 推奨事項

1. **`dangerouslySetInnerHTML` の使用箇所にサニタイズ処理を追加**
   - `DOMPurify` などのライブラリを使用
   - または、Markdownパーサーを使用してHTMLを生成

2. **ユーザー入力データのサニタイズ**
   - SNS投稿などのユーザー入力データは必ずサニタイズ
   - 管理者が管理する静的コンテンツも念のためサニタイズ

## 3. SQLインジェクション対策

### 3.1 Supabaseクライアントの使用

すべてのデータベース操作でSupabaseクライアントが使用されています。

**評価**: ✅ **適切**

- Supabaseクライアントは自動的にパラメータ化クエリを使用
- SQLインジェクションのリスクは低い

### 3.2 RPC関数の使用

以下の箇所でRPC関数が使用されています：

- `create_slot_booking` - パラメータ化された関数呼び出し
- `cancel_slot_booking` - パラメータ化された関数呼び出し
- `get_organizer_revenue` - パラメータ化された関数呼び出し
- `select_admin_lottery_winners` - パラメータ化された関数呼び出し

**評価**: ✅ **適切**

- RPC関数はパラメータ化されており、SQLインジェクションのリスクは低い

### 3.3 生SQLクエリの使用

生SQLクエリの使用は確認されませんでした。

**評価**: ✅ **良好**

## 4. ファイルアップロードの検証

### 4.1 ファイルタイプの制限

- ✅ 画像ファイル: `.jpg`, `.jpeg`, `.png`, `.webp` など
- ✅ ファイルサイズ制限: 実装確認必要

### 4.2 ファイル名のサニタイズ

- ✅ ファイル名のサニタイズ処理が実装されているか確認必要

### 4.3 推奨事項

1. **ファイルタイプの厳格な検証**
   - MIMEタイプの検証
   - ファイル拡張子の検証

2. **ファイルサイズ制限の明確化**
   - 各機能ごとのファイルサイズ制限を明確化
   - エラーメッセージの改善

3. **ファイル名のサニタイズ**
   - 危険な文字の除去
   - パストラバーサル攻撃の防止

## 5. 発見された問題点

### 5.1 軽微な問題

1. **`dangerouslySetInnerHTML` の使用**
   - 問題: 3箇所で使用されているが、サニタイズ処理が不足
   - 影響: 中（XSS攻撃のリスク）
   - 推奨: サニタイズ処理の追加

2. **ファイルアップロードの検証**
   - 問題: ファイルタイプ・サイズ・名前の検証が不十分な可能性
   - 影響: 中（悪意のあるファイルのアップロードリスク）
   - 推奨: 検証処理の強化

### 5.2 重大な問題

**なし**

## 6. 推奨事項

### 6.1 即座対応（高優先度）

1. **`dangerouslySetInnerHTML` のサニタイズ処理追加**
   - `DOMPurify` ライブラリの導入
   - すべての `dangerouslySetInnerHTML` 使用箇所にサニタイズ処理を追加

2. **ファイルアップロードの検証強化**
   - ファイルタイプの厳格な検証
   - ファイルサイズ制限の明確化
   - ファイル名のサニタイズ

### 6.2 中期的対応（中優先度）

1. **Zodスキーマの統一化**
   - 共通バリデーションパターンの抽出
   - 再利用可能なスキーマの作成

2. **サーバー側バリデーションの強化**
   - Server ActionsでのZodスキーマ検証
   - クライアント側とサーバー側のバリデーション統一

## 7. 結論

### 総合評価: ✅ **良好**

- Zodスキーマが主要なフォームで使用されています
- SQLインジェクション対策は適切に実装されています
- XSS対策は基本的に実装されていますが、`dangerouslySetInnerHTML` の使用箇所で改善の余地があります
- ファイルアップロードの検証を強化する必要があります

### 次のステップ

1. `dangerouslySetInnerHTML` のサニタイズ処理追加
2. ファイルアップロードの検証強化
3. 機密情報保護の確認
4. 脆弱性スキャン
