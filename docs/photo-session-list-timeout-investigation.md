# 撮影会一覧タイムアウト調査結果

## 調査日時
2025-12-22

## 問題の概要
撮影会一覧ページ（`PhotoSessionList`コンポーネント）で詳細画面から戻った際に、`listPhotoSessions`クエリが30秒のタイムアウトエラーを発生させることがある。

## 調査結果

### 1. データベース側のパフォーマンス

#### 1.1 テーブル構造とインデックス

**photo_sessionsテーブル**:
- 行数: 73行
- サイズ: 608 kB
- インデックス数: 15個

**主要インデックス**:
- `idx_photo_sessions_start_time` - 2884回使用
- `idx_photo_sessions_organizer_id` - 5931回使用
- `idx_photo_sessions_is_published` - 77回使用（使用頻度が低い）

**問題点**:
- `is_published`と`start_time`の複合条件に対して、単一のインデックスしか使用されていない
- `is_published`のフィルタリングがインデックススキャン後に実行されている

#### 1.2 クエリ実行計画の分析

**基本クエリ（フィルターなし）**:
- 実行時間: 0.243ms
- Planning Time: 1.936ms
- インデックス使用: `idx_photo_sessions_start_time`
- 問題: `is_published`のフィルタリングがインデックススキャン後に実行されている

**キーワード検索**:
- 実行時間: 0.231ms
- Planning Time: 19.249ms（長い）
- 問題: Planning Timeが長い

**複数フィルター適用**:
- 実行時間: 0.239ms
- Planning Time: 4.805ms
- 問題: Planning Timeが長い

#### 1.3 データベース統計情報

- `photo_sessions`: 73行、608 kB
- `profiles`: 319行、704 kB
- データ量は少なく、パフォーマンス問題の原因ではない

#### 1.4 接続状態

- 総接続数: 17
- アクティブ接続: 2
- アイドル接続: 13
- 接続プールの枯渇はない

#### 1.5 RLSポリシー

以下のRLSポリシーが設定されている：
- `Anyone can view published photo sessions` - `is_published = true`
- `Organizers can manage own photo sessions` - `auth.uid() = organizer_id`
- `models_can_view_their_featured_sessions` - `featured_model_id = auth.uid() OR organizer_id = auth.uid()`

**問題点**:
- RLSポリシーの評価がクエリ実行時間に影響を与えている可能性がある

### 2. クライアント側の調査

#### 2.1 クエリラッパー（`query-wrapper.ts`）

- デフォルトタイムアウト: 30秒
- `Promise.race`を使用してタイムアウトを実装
- タイムアウト発生時も実際のクエリは継続実行される可能性がある

#### 2.2 SWRキャッシュ設定（`usePhotoSessions.ts`）

- `dedupingInterval`: 10秒（短い）
- 詳細画面から戻った際に頻繁に再クエリが発生する可能性がある

#### 2.3 Supabaseクライアント作成

- `createBrowserClient`を毎回呼び出している
- クライアントの再利用ができていない可能性がある

## 根本原因の特定

### データベース側の問題ではない

調査結果から、データベース側のクエリ実行自体は非常に高速（0.2-3ms）であり、タイムアウトの直接的な原因ではないことが判明しました。

### 考えられる原因

1. **ネットワークレイテンシ**: Supabaseへの接続が遅い
2. **Supabase PostgRESTのオーバーヘッド**: PostgRESTがクエリを変換・実行する際のオーバーヘッド
3. **RLSポリシーの評価**: RLSポリシーが複雑で、評価に時間がかかっている
4. **Planning Time**: クエリプランナーが最適な実行計画を見つけるのに時間がかかっている（最大19.249ms）
5. **SWRキャッシュ**: `dedupingInterval`が10秒と短く、詳細画面から戻った際に頻繁に再クエリが発生している

## 解決策

### Phase 1: 即座対応（タイムアウト延長とキャッシュ最適化）

1. **タイムアウト時間の延長**
   - `query-wrapper.ts`のデフォルトタイムアウトを30秒→60秒に延長
   - ネットワークレイテンシやPostgRESTのオーバーヘッドを考慮

2. **SWRキャッシュ設定の最適化**
   - `usePhotoSessions.ts`の`dedupingInterval`を10秒→30秒に延長
   - 詳細画面から戻った際の不要なクエリ実行を抑制

### Phase 2: データベース最適化（根本的な改善）

1. **複合インデックスの追加**
   - `is_published`と`start_time`の複合インデックスを作成
   - クエリプランナーが最適な実行計画を選択できるようにする

2. **部分インデックスの使用**
   - `is_published = true`の条件で部分インデックスを作成
   - インデックスサイズを削減し、パフォーマンスを向上

### Phase 3: クライアント側の最適化（長期的な改善）

1. **Supabaseクライアントの再利用**
   - クライアントをシングルトンとして管理
   - 毎回新しいクライアントを作成しない

2. **エラーハンドリングの改善**
   - タイムアウト発生時の詳細ログを追加
   - クエリパラメータや実行時間の内訳を記録

## 実装優先順位

1. **優先度A（即座対応）**:
   - タイムアウト時間の延長（30秒→60秒）
   - SWRキャッシュ設定の最適化（10秒→30秒）

2. **優先度B（根本的な改善）**:
   - 複合インデックスの追加
   - 部分インデックスの使用

3. **優先度C（長期的な改善）**:
   - Supabaseクライアントの再利用
   - エラーハンドリングの改善

## 期待される効果

- **タイムアウトエラーの解消**: タイムアウト時間の延長により、一時的なネットワーク遅延に対応
- **クエリ実行回数の削減**: SWRキャッシュの最適化により、不要なクエリ実行を抑制
- **クエリ実行時間の改善**: 複合インデックスの追加により、Planning Timeを短縮

## 今後の監視項目

- タイムアウトエラーの発生率
- クエリ実行時間の分布
- Planning Timeの推移
- SWRキャッシュヒット率

