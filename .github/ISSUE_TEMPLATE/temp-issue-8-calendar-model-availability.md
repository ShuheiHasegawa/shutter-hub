---
name: カレンダーでの所属モデル/運営空き時間表示機能
about: 運営者とモデルが相互に空き時間を確認できるカレンダー機能の実装
title: '[Feature] カレンダーでの所属モデル/運営空き時間表示機能 #8'
labels: feature, calendar, organizer-model
assignees: ''
---

## 📋 概要
運営者が所属モデルの空き時間を、モデルが所属運営の空き時間をカレンダー上で確認できる機能を実装する。相互のスケジュール調整を効率化し、撮影会の企画を円滑にする。

## 🎯 背景・目的
- **問題点**: 
  - 運営者が所属モデルの空き時間を確認する際、個別に連絡を取る必要があった
  - モデルが所属運営の対応可能時間を把握できず、スケジュール調整が非効率だった
  - カレンダー上で複数のモデルの空き時間を一覧で確認できなかった
- **目的**: 
  - 運営者とモデルが相互に空き時間を可視化し、スケジュール調整を効率化する
  - カレンダー上で複数のモデルの空き時間を色分けして表示し、一目で把握できるようにする
  - 日付クリック時のモーダルで詳細な空き時間情報を確認できるようにする

## 📝 実装内容

### カレンダー機能
- [x] 運営者側：所属モデルの空き時間をカレンダー上に色分けして表示
- [x] 運営者側：日付クリック時のモーダルに所属モデルの空き時間を表示
- [x] モデル側：日付クリック時のモーダルに所属運営の対応可能時間を表示
- [x] モデルごとに16色のカラーパレットで区別（8色から拡張）
- [x] 表示フォーマットを「時間: 名前」に統一（モバイル対応）
- [x] MultiSelectコンポーネントでモデル選択フィルター機能を実装
- [x] 名前入力による絞り込み機能
- [x] 全選択/全解除機能
- [x] セレクトボックス内にカラーマークを表示
- [x] モデル選択UIを年月選択の下に配置
- [x] モーダル内の空き時間追加ボタンを所属モデルセクションの前に配置
- [x] ページタイトルを「カレンダー」に変更
- [x] 色凡例を削除（MultiSelect内のカラーマークで代替）

### 所属モデル管理機能の強化
- [x] 所属モデル解除機能を実装（三点メニューから実行）
- [x] 所属解除時の確認ダイアログを追加
- [x] 所属モデルの空き時間件数（3ヶ月先まで）を表示
- [x] モデル招待フォームをモーダル化
- [x] 新規招待ボタンを画面右上に配置してUIの一貫性を向上

## 🔧 技術的な考慮事項

### データ取得
- `user_availability`テーブルのRLSポリシーを活用
  - 運営者は所属モデルの空き時間を閲覧可能（編集不可）
  - モデルは所属運営の空き時間を閲覧可能（編集不可）
- 月単位でデータを取得し、パフォーマンスを最適化
- モデルごとに空き時間を個別に管理し、色分け表示を実現

### カラーパレット
- 16色のカラーパレットを循環割当で使用
- モデルIDに基づいて一意の色を割り当て
- カレンダー上とMultiSelect内で同じ色を使用して一貫性を保持

### UI/UX
- モバイル対応：表示フォーマットを「時間: 名前」に統一（時間を優先表示）
- フィルター機能：MultiSelectコンポーネントで直感的な操作を実現
- 視覚的区別：カラーマークと色分け表示でモデルを識別

### パフォーマンス
- 月変更時にのみデータを再取得
- モデルごとの空き時間データを効率的に管理
- 不要な再レンダリングを防止

## 🎨 UI/UX要件

### カレンダー表示
- 運営者側：所属モデルの空き時間を色分けしてカレンダー上に表示
- 各モデルの空き時間は左側にカラーマークを表示
- 表示フォーマット：「時間: 名前」（例：「10:00-18:00: 橋本環奈」）

### モーダル表示
- **運営者側**：
  1. 自分の設定済み空き時間（編集・削除可能）
  2. 区切り線
  3. 空き時間を追加ボタン
  4. 区切り線（所属モデルの空き時間がある場合）
  5. 所属モデルの空き時間セクション
     - 各モデルの名前、カラーマーク、空き時間を表示
- **モデル側**：
  1. 自分の設定済み空き時間（編集・削除可能）
  2. 区切り線
  3. 空き時間を追加ボタン
  4. 区切り線（所属運営の空き時間がある場合）
  5. 所属運営の対応可能時間セクション（閲覧のみ）

### フィルター機能
- MultiSelectコンポーネントでモデル選択
- 各モデル名の先頭にカラーマークを表示
- 名前入力による絞り込み機能
- 全選択/全解除ボタン
- 選択したモデルのみカレンダー上に表示

### 所属モデル管理画面
- モデルカードに空き時間（3ヶ月先まで）の件数を表示
- 三点メニューから所属解除機能にアクセス
- 確認ダイアログで誤操作を防止

## ✅ 完了条件
- [x] すべてのタスクが完了
- [ ] CodeRabbitレビュー通過
- [ ] E2Eテスト通過
  - [ ] 運営者アカウントでカレンダーの日付をクリック
  - [ ] モーダルに「所属モデルの空き時間」セクションが表示される
  - [ ] 各モデルの空き時間が正しく表示される
  - [ ] モデルのカラーマークが正しく表示される
  - [ ] 空き時間がないモデルは表示されない
  - [ ] フィルターで非選択のモデルは表示されない
  - [ ] 自分の空き時間とモデルの空き時間が区別されている
  - [ ] モデルアカウントでカレンダーの日付をクリック
  - [ ] モーダルに「所属運営の対応可能時間」セクションが表示される
  - [ ] モバイルでも正しく表示される
- [ ] ドキュメント更新（必要に応じて）

## 🔗 関連Issue
<!-- 関連するIssueがあれば記載 -->
<!-- Related to #XX -->

## 📚 参考資料
- `.cursor/rules/dev-rules/development-guide.mdc` - 開発ルール
- `.cursor/rules/dev-rules/unified-color-system.mdc` - カラーシステム統一ルール
- `docs/user-schedule-management-spec.md` - ユーザースケジュール管理仕様
- `supabase/migrations/20250924095138_create_user_availability_correct.sql` - user_availabilityテーブル定義とRLSポリシー

## 📸 スクリーンショット・モックアップ
<!-- UI変更がある場合は、スクリーンショットやモックアップを添付 -->

### 実装ファイル
- `src/app/[locale]/calendar/page.tsx` - カレンダーページの実装
- `src/components/profile/organizer/OrganizerModelsCommon.tsx` - 所属モデル管理コンポーネント
- `src/components/profile/organizer/OrganizerModelManagement.tsx` - 所属モデル管理画面
- `src/components/profile/organizer/ModelInvitationForm.tsx` - モデル招待フォーム
- `src/components/ui/multi-select.tsx` - MultiSelectコンポーネント（既存）

### データベース
- `user_availability`テーブル - ユーザー空き時間管理
- `organizer_models`テーブル - 運営者とモデルの関連
- RLSポリシーによるアクセス制御
