---
name: 認証フックの最適化
about: グローバルキャッシュによる認証状態管理の最適化
title: '[Refactor] 認証フックの最適化（グローバルキャッシュ）'
labels: refactor, performance
assignees: ''
---

## 📋 概要
`useAuth`フックにグローバルキャッシュを実装し、複数コンポーネントでの重複認証チェックを防止する。

## 🎯 背景・目的
- **問題点**: 複数のコンポーネントで`useAuth`が呼び出されると、それぞれが個別に認証状態を取得
- **目的**: グローバルキャッシュにより、認証状態の取得を1回に統一し、パフォーマンスを改善

## 🔍 現状の問題点
- 複数のコンポーネントで`useAuth`が呼び出されると、それぞれが`getUser()`を実行
- 同一セッション内で複数回の認証チェックが発生し、無駄なリクエストが発生
- `getUser()`は毎回サーバーにリクエストを送信し、レスポンスが遅い

## 💡 改善案
- グローバルキャッシュ変数を導入し、最初の呼び出し時のみ認証状態を取得
- `getUser()`から`getSession()`に変更し、ローカルキャッシュから取得
- Promiseを再利用し、並行呼び出し時の重複リクエストを防止

## 📝 実装内容
- [x] グローバルキャッシュ変数（`cachedUser`, `cachedLoading`, `authPromise`）の追加
- [x] `getUser()`から`getSession()`への変更
- [x] Promise再利用ロジックの実装
- [x] エラーハンドリングの最適化

## 🔧 技術的な考慮事項
- `getSession()`はローカルキャッシュから取得するため、`getUser()`より高速
- グローバルキャッシュにより、同一セッション内での重複取得を防止
- Promise再利用により、並行呼び出し時の重複リクエストを防止

## ⚠️ 破壊的変更
- [x] 破壊的変更なし（既存のAPIは維持）

## ✅ 完了条件
- [x] すべてのタスクが完了
- [ ] CodeRabbitレビュー通過
- [ ] パフォーマンステスト通過（認証チェック回数の削減確認）

## 📚 参考資料
- Supabase Auth Session管理: https://supabase.com/docs/guides/auth/sessions
