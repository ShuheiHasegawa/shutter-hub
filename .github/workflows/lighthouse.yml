name: âš¡ Lighthouse CI

on:
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'next.config.ts'
      - '.github/workflows/lighthouse.yml'

  # æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
  workflow_dispatch:
    inputs:
      url:
        description: 'åˆ†æžå¯¾è±¡URL'
        required: false
        default: 'https://shutterhub.app'

env:
  NODE_VERSION: '20'

jobs:
  lighthouse:
    name: âš¡ Lighthouseãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹åˆ†æž
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true # å€‹äººé–‹ç™ºã§ã¯è­¦å‘Šã®ã¿

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ðŸ—ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: ðŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
        run: npm start &
        env:
          NODE_ENV: production
          SKIP_ENV_VALIDATION: true

      - name: â³ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¾…æ©Ÿ
        run: |
          echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¾…æ©Ÿä¸­..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å®Œäº†"
              break
            fi
            echo "å¾…æ©Ÿä¸­... ($i/30)"
            sleep 2
          done

      - name: ðŸ”’ URLæ¤œè¨¼
        id: validate-url
        run: |
          INPUT_URL="${{ github.event.inputs.url }}"
          ALLOWED_DOMAINS="localhost|shutterhub.app|shutterhub.vercel.app"
          
          if [[ -z "$INPUT_URL" ]]; then
            echo "url=http://localhost:3000" >> $GITHUB_OUTPUT
            echo "âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLã‚’ä½¿ç”¨: http://localhost:3000"
          elif echo "$INPUT_URL" | grep -E "^https?://(${ALLOWED_DOMAINS})" > /dev/null; then
            echo "url=$INPUT_URL" >> $GITHUB_OUTPUT
            echo "âœ… æ¤œè¨¼æ¸ˆã¿URLã‚’ä½¿ç”¨: $INPUT_URL"
          else
            echo "âš ï¸ ä¸æ­£ãªURLãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
            echo "url=http://localhost:3000" >> $GITHUB_OUTPUT
          fi

      - name: âš¡ Lighthouse CIå®Ÿè¡Œ
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            ${{ steps.validate-url.outputs.url }}
            ${{ steps.validate-url.outputs.url }}/ja
            ${{ steps.validate-url.outputs.url }}/ja/photo-sessions
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: ðŸ“Š Lighthouseçµæžœã‚µãƒžãƒªãƒ¼
        if: always()
        run: |
          echo "## âš¡ Lighthouse CIçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡URL**: ${{ steps.validate-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒãƒ¼ãƒˆ**: 3000ï¼ˆNext.jsæ¨™æº–ãƒãƒ¼ãƒˆï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯ Artifacts ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèªã§ãã¾ã™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ç›®æ¨™ã‚¹ã‚³ã‚¢" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance**: 90ä»¥ä¸Š" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility**: 95ä»¥ä¸Š" >> $GITHUB_STEP_SUMMARY
          echo "- **Best Practices**: 95ä»¥ä¸Š" >> $GITHUB_STEP_SUMMARY
          echo "- **SEO**: 95ä»¥ä¸Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ å€‹äººé–‹ç™ºæœ€é©åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚¹ã‚³ã‚¢ãŒç›®æ¨™æœªé”ã§ã‚‚é–‹ç™ºã‚’å¦¨ã’ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹åŠ£åŒ–ã®æ—©æœŸæ¤œå‡ºãŒç›®çš„ã§ã™" >> $GITHUB_STEP_SUMMARY

