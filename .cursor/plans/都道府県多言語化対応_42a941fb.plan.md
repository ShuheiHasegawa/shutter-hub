---
name: 都道府県多言語化対応
overview: データベースに日本語で保存されている都道府県データを、英語キーベースに移行し、next-intlによる多言語化対応を実現する。既存データのマイグレーションと、フロントエンドの多言語化対応を含む包括的な実装。
todos:
  - id: update-constants
    content: src/constants/japan.ts に都道府県キー定義とマッピングテーブルを追加
    status: completed
  - id: add-translations
    content: messages/ja.json と messages/en.json に47都道府県の翻訳を追加
    status: completed
    dependencies:
      - update-constants
  - id: create-prefecture-select
    content: src/components/ui/prefecture-select.tsx を新規作成
    status: completed
    dependencies:
      - add-translations
  - id: create-prefecture-utils
    content: src/lib/utils/prefecture.ts にデータ変換ユーティリティを作成
    status: completed
    dependencies:
      - update-constants
  - id: update-forms
    content: StudioCreateForm, StudioEditForm, ProfileEditForm などのフォームを更新
    status: completed
    dependencies:
      - create-prefecture-select
  - id: update-server-actions
    content: Server Actions でデータ正規化処理を追加
    status: completed
    dependencies:
      - create-prefecture-utils
  - id: update-display-components
    content: 都道府県を表示する全コンポーネントを多言語化対応
    status: completed
    dependencies:
      - add-translations
  - id: create-migration
    content: データベースマイグレーションファイルを作成（既存データを英語キーに変換）
    status: completed
    dependencies:
      - update-constants
  - id: test-verification
    content: 全機能のテスト・検証（表示、作成、編集、検索、言語切り替え）
    status: completed
    dependencies:
      - update-forms
      - update-server-actions
      - update-display-components
      - create-migration
---

# 都道府県多言語化対応プラン

## 調査結果サマリー

### 現状の問題点

1. **データベース**: `studios.prefecture`, `profiles.prefecture` に日本語名（例: "東京都"）が直接保存されている
2. **定数ファイル**: [`src/constants/japan.ts`](src/constants/japan.ts) に日本語の都道府県配列が定義されている
3. **フォーム**: [`src/components/studio/StudioCreateForm.tsx`](src/components/studio/StudioCreateForm.tsx) など複数のフォームで日本語の都道府県名を直接表示
4. **多言語化未対応**: メッセージファイルに都道府県の翻訳が存在しない

### 影響範囲

- **データベーステーブル**: `studios` (10 件), `profiles` (1 件以上)
- **使用箇所**: 14 ファイル（grep 結果より）

## 実装方針

### オプション選択: ハイブリッド方式（推奨）

**理由**:

1. **データベース互換性**: 既存の日本語データをそのまま活用できる
2. **型安全性**: TypeScript の型定義で都道府県キーを厳密に管理
3. **パフォーマンス**: 定数マッピングテーブルで高速変換
4. **next-intl 準拠**: メッセージファイルで翻訳を一元管理

## 実装ステップ

### 1. 都道府県キー定義とマッピング作成

[`src/constants/japan.ts`](src/constants/japan.ts) を更新:

```typescript
// 都道府県キー（英語）の定義
export const PREFECTURE_KEYS = [
  "hokkaido",
  "aomori",
  "iwate",
  "miyagi",
  "akita",
  "yamagata",
  "fukushima",
  "ibaraki",
  "tochigi",
  "gunma",
  "saitama",
  "chiba",
  "tokyo",
  "kanagawa",
  // ... 全47都道府県
] as const;

export type PrefectureKey = (typeof PREFECTURE_KEYS)[number];

// 日本語名 → キー の変換マップ（既存データ対応）
export const PREFECTURE_JA_TO_KEY: Record<string, PrefectureKey> = {
  北海道: "hokkaido",
  青森県: "aomori",
  // ... 全47都道府県
};

// キー → 日本語名 の変換マップ（後方互換性）
export const PREFECTURE_KEY_TO_JA: Record<PrefectureKey, string> = {
  hokkaido: "北海道",
  aomori: "青森県",
  // ... 全47都道府県
};
```

### 2. メッセージファイルに翻訳追加

[`messages/ja.json`](messages/ja.json) に追加:

```json
{
  "prefecture": {
    "hokkaido": "北海道",
    "aomori": "青森県",
    "tokyo": "東京都"
    // ... 全47都道府県
  }
}
```

[`messages/en.json`](messages/en.json) に追加:

```json
{
  "prefecture": {
    "hokkaido": "Hokkaido",
    "aomori": "Aomori",
    "tokyo": "Tokyo"
    // ... 全47都道府県
  }
}
```

### 3. 都道府県セレクトボックスコンポーネント作成

新規ファイル `src/components/ui/prefecture-select.tsx`:

```typescript
"use client";

import { useTranslations } from "next-intl";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { PREFECTURE_KEYS, type PrefectureKey } from "@/constants/japan";

interface PrefectureSelectProps {
  value?: string;
  onValueChange: (value: PrefectureKey) => void;
  placeholder?: string;
}

export function PrefectureSelect({
  value,
  onValueChange,
  placeholder,
}: PrefectureSelectProps) {
  const t = useTranslations("prefecture");

  return (
    <Select value={value} onValueChange={onValueChange}>
      <SelectTrigger>
        <SelectValue placeholder={placeholder || t("selectPlaceholder")} />
      </SelectTrigger>
      <SelectContent>
        {PREFECTURE_KEYS.map((key) => (
          <SelectItem key={key} value={key}>
            {t(key)}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```

### 4. 既存フォームの更新

以下のファイルを更新:

- [`src/components/studio/StudioCreateForm.tsx`](src/components/studio/StudioCreateForm.tsx)
- [`src/components/studio/StudioEditForm.tsx`](src/components/studio/StudioEditForm.tsx)
- [`src/components/profile/ProfileEditForm.tsx`](src/components/profile/ProfileEditForm.tsx)
- その他の都道府県選択を使用しているフォーム

変更内容:

```typescript
// Before
import { PREFECTURES } from "@/constants/japan";

<Select onValueChange={(value) => form.setValue("prefecture", value)}>
  {PREFECTURES.map((prefecture) => (
    <SelectItem key={prefecture} value={prefecture}>
      {prefecture}
    </SelectItem>
  ))}
</Select>;

// After
import { PrefectureSelect } from "@/components/ui/prefecture-select";

<PrefectureSelect
  value={form.watch("prefecture")}
  onValueChange={(value) => form.setValue("prefecture", value)}
/>;
```

### 5. データベースマイグレーション（既存データ対応）

**重要**: 既存データが日本語名で保存されているため、以下の 2 つのアプローチを検討:

#### アプローチ A: データベース移行（推奨）

マイグレーションファイル作成:

```sql
-- studios テーブルの都道府県を英語キーに変換
UPDATE studios
SET prefecture = CASE prefecture
  WHEN '北海道' THEN 'hokkaido'
  WHEN '青森県' THEN 'aomori'
  WHEN '東京都' THEN 'tokyo'
  -- ... 全47都道府県
  ELSE prefecture
END;

-- profiles テーブルの都道府県を英語キーに変換
UPDATE profiles
SET prefecture = CASE prefecture
  WHEN '北海道' THEN 'hokkaido'
  WHEN '青森県' THEN 'aomori'
  WHEN '東京都' THEN 'tokyo'
  -- ... 全47都道府県
  ELSE prefecture
END
WHERE prefecture IS NOT NULL;
```

### 6. Server Actions / API の更新

[`src/app/actions/studio.ts`](src/app/actions/studio.ts) などの Server Actions を更新:

```typescript
import { normalizePrefecture } from "@/lib/utils/prefecture";

// データ取得時に正規化
const studios = data.map((studio) => ({
  ...studio,
  prefecture: normalizePrefecture(studio.prefecture),
}));
```

### 7. 表示コンポーネントの更新

都道府県を表示する箇所を多言語化:

```typescript
// Before
<p>{studio.prefecture}</p>;

// After
const t = useTranslations("prefecture");
<p>{studio.prefecture ? t(studio.prefecture) : "-"}</p>;
```

### 8. テスト・検証

1. **既存データの表示確認**: 日本語で保存されたデータが正しく表示されるか
2. **新規作成**: 新しいスタジオ/プロフィールが正しく保存されるか
3. **言語切り替え**: 日本語 ⇔ 英語で都道府県名が正しく切り替わるか
4. **検索・フィルター**: 都道府県での検索が正常に動作するか

## マイグレーション戦略

### 推奨: 段階的移行

1. **Phase 1**: アプリケーション層での変換実装（後方互換性確保）
2. **Phase 2**: 新規データは英語キーで保存開始
3. **Phase 3**: データベースマイグレーション実行（既存データ変換）
4. **Phase 4**: 変換ロジック削除（クリーンアップ）

## 影響を受けるファイル一覧

- `src/constants/japan.ts` - 都道府県定義の大幅更新
- `messages/ja.json` - 47 都道府県の翻訳追加
- `messages/en.json` - 47 都道府県の翻訳追加
- `src/components/ui/prefecture-select.tsx` - 新規作成
- `src/lib/utils/prefecture.ts` - 新規作成
- `src/components/studio/StudioCreateForm.tsx` - 更新
- `src/components/studio/StudioEditForm.tsx` - 更新
- `src/components/profile/ProfileEditForm.tsx` - 更新
- `src/app/actions/studio.ts` - 更新
- その他、都道府県を使用している全コンポーネント

## 注意事項

1. **データ整合性**: マイグレーション前に必ずバックアップを取得
2. **検索機能**: 都道府県での検索クエリも更新が必要
3. **キャッシュ**: 既存のキャッシュデータのクリアが必要な場合がある
4. **テストデータ**: 開発環境で十分にテストしてから本番適用