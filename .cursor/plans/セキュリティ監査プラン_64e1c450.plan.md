---
name: セキュリティ監査プラン
overview: ShutterHub のリリース前セキュリティ監査を実施し、認証・認可・RLS・入力検証・機密情報保護の全面確認を行う。
todos:
  - id: rls-audit
    content: RLS（Row Level Security）ポリシーの全面監査
    status: completed
  - id: auth-check
    content: 認証・認可チェックの全面確認（Server Actions/Components）
    status: completed
    dependencies:
      - rls-audit
  - id: input-validation
    content: 入力検証の確認（Zodスキーマ、XSS、SQLインジェクション対策）
    status: completed
    dependencies:
      - auth-check
  - id: sensitive-data
    content: 機密情報保護の確認（環境変数、ログ、APIレスポンス）
    status: completed
    dependencies:
      - input-validation
  - id: vulnerability-scan
    content: 脆弱性スキャン（npm audit、セキュリティヘッダー）
    status: completed
    dependencies:
      - sensitive-data
  - id: security-report
    content: セキュリティ監査レポート作成
    status: completed
    dependencies:
      - vulnerability-scan
---

# セキュリティ監査プラン

## 概要

ShutterHub のリリース前に必須のセキュリティ監査を実施します。認証・認可・RLS（Row Level Security）・入力検証・機密情報保護の全面確認を行い、脆弱性を特定・修正します。

## 目標

- **認証・認可の漏れゼロ**: 全エンドポイントで適切な認証チェック
- **RLS ポリシーの完全性**: データベースレベルでのアクセス制御確認
- **入力検証の徹底**: XSS・インジェクション攻撃への対策確認
- **機密情報の保護**: 環境変数・ログ・API レスポンスでの漏洩防止

## 実装手順

### 1. RLS（Row Level Security）ポリシーの全面監査

#### 対象テーブル（61 マイグレーションファイル）

**主要テーブル群**:

- `profiles`: ユーザープロフィール
- `photo_sessions`: 撮影会
- `bookings`: 予約
- `lottery_sessions`, `lottery_entries`: 抽選システム
- `admin_lottery_sessions`, `admin_lottery_entries`: 管理抽選
- `user_ranks`, `priority_tickets`, `priority_booking_settings`: 優先予約
- `waitlist_entries`, `waitlist_settings`: キャンセル待ち
- `instant_photo_requests`: 即座撮影リクエスト
- `payments`, `payment_transactions`: 決済
- `reviews`: レビュー
- `messages`, `conversations`: メッセージング
- `photobooks`, `photos`, `spread_layouts`: フォトブック
- `studios`, `studio_photos`: スタジオ
- `user_subscriptions`, `subscription_plans`: サブスクリプション
- `user_availability`: スケジュール管理

#### チェック項目

1. **RLS 有効化確認**
   ```sql
   -- 全テーブルでRLSが有効か確認
   SELECT tablename, rowsecurity
   FROM pg_tables
   WHERE schemaname = 'public'
   AND rowsecurity = false;
   ```

2. **ポリシーの網羅性確認**

   - SELECT: 誰が閲覧できるか
   - INSERT: 誰が作成できるか
   - UPDATE: 誰が更新できるか
   - DELETE: 誰が削除できるか

3. **権限エスカレーションの確認**

   - 一般ユーザーが管理者データにアクセスできないか
   - 他ユーザーのプライベートデータにアクセスできないか
   - 主催者が他の主催者のデータを操作できないか

4. **特に注意すべきテーブル**

   - `payments`: 決済情報の漏洩防止
   - `messages`: プライベートメッセージの保護
   - `user_subscriptions`: サブスクリプション情報の保護
   - `priority_tickets`: チケット不正利用の防止

### 2. 認証・認可チェックの全面確認

#### Server Actions の確認

**統一化済み（t0-070 完了）**:

- `src/app/actions/photo-session.ts`
- `src/app/actions/bookings.ts`
- `src/app/actions/instant-photo.ts`
- `src/app/actions/reviews.ts`
- `src/app/actions/favorites.ts`
- `src/app/actions/payments.ts`
- `src/app/actions/message.ts`
- `src/app/actions/organizer-model.ts`
- `src/app/actions/admin-system.ts`
- その他 23 ファイル（合計約 60 箇所）

**未統一化（要確認）**:

- Server Components: 約 15 ファイル 25 箇所
- 認証不要の公開エンドポイント（意図的な場合は文書化）

#### チェック項目

1. **認証チェック漏れの確認**
   ```bash
   # Server Actionsで認証チェックがない箇所を検索
   grep -r "export async function" src/app/actions/ | \
   grep -v "requireAuthForAction\|requireUserType\|requireAdminRole"
   ```

2. **権限チェックの適切性**

   - ユーザータイプ別の機能制限（model/photographer/organizer）
   - 管理者機能の権限チェック
   - 所有者チェック（自分のデータのみ操作可能）

3. **エラーハンドリングの確認**

   - 認証エラー時の適切なレスポンス
   - 機密情報を含まないエラーメッセージ

### 3. 入力検証の確認

#### Zod スキーマの確認

**主要フォーム**:

- プロフィール編集
- 撮影会作成・編集
- 予約作成
- メッセージ送信
- レビュー投稿
- 決済情報入力

#### チェック項目

1. **XSS 対策**

   - HTML タグのエスケープ確認
   - スクリプトタグの除去確認
   - Next.js の自動エスケープ確認

2. **SQL インジェクション対策**

   - Supabase クライアント使用確認（基本対応済み）
   - 生 SQL クエリの有無確認
   - パラメータ化クエリの使用確認

3. **バリデーション漏れの確認**
   ```typescript
   // 全フォームでZodスキーマが使用されているか確認
   // 必須フィールドの検証
   // データ型の検証
   // 文字列長の制限
   // 数値範囲の制限
   ```

4. **ファイルアップロードの検証**

   - ファイルタイプの制限
   - ファイルサイズの制限
   - ファイル名のサニタイズ

### 4. 機密情報保護の確認

#### 環境変数の確認

1. **`.env.local` の確認**

   - API キー・シークレットが適切に管理されているか
   - `.gitignore` に含まれているか
   - 本番環境で異なる値を使用しているか

2. **クライアント側での使用確認**
   ```bash
   # NEXT_PUBLIC_ プレフィックスのない環境変数が
   # クライアントコンポーネントで使用されていないか確認
   grep -r "process.env" src/components/ src/app/
   ```


#### ログ出力の確認

1. **機密情報のログ出力確認**
   ```bash
   # パスワード、トークン、APIキーがログに出力されていないか
   grep -r "console.log\|logger.debug\|logger.info" src/ | \
   grep -i "password\|token\|secret\|api_key"
   ```

2. **本番環境でのログレベル確認**

   - `NEXT_PUBLIC_LOG_LEVEL` の設定確認
   - デバッグログが本番で出力されないことを確認

#### API レスポンスの確認

1. **機密情報の漏洩確認**

   - パスワードハッシュが返されていないか
   - 内部 ID が不必要に公開されていないか
   - エラーメッセージにスタックトレースが含まれていないか

### 5. セキュリティチェックリストの作成

#### 認証・認可

- [ ] 全 Server Actions で認証チェック実施
- [ ] 全 Server Components で認証チェック実施
- [ ] ユーザータイプ別の権限チェック実施
- [ ] 管理者機能の権限チェック実施
- [ ] 所有者チェック実施（自分のデータのみ操作）

#### RLS

- [ ] 全テーブルで RLS 有効化
- [ ] SELECT/INSERT/UPDATE/DELETE ポリシー設定
- [ ] 権限エスカレーション防止確認
- [ ] プライベートデータ保護確認

#### 入力検証

- [ ] 全フォームで Zod スキーマ使用
- [ ] XSS 対策実施
- [ ] SQL インジェクション対策実施
- [ ] ファイルアップロード検証実施

#### 機密情報保護

- [ ] 環境変数の適切な管理
- [ ] ログ出力での機密情報漏洩防止
- [ ] API レスポンスでの機密情報漏洩防止
- [ ] `.gitignore` の確認

### 6. 脆弱性スキャン

#### 依存関係の脆弱性確認

```bash
# npm audit実行
npm audit

# 重大な脆弱性の修正
npm audit fix

# 手動修正が必要な場合
npm audit fix --force
```

#### セキュリティヘッダーの確認

`next.config.js` で以下のヘッダーが設定されているか確認:

```javascript
headers: [
  {
    key: "X-Frame-Options",
    value: "DENY",
  },
  {
    key: "X-Content-Type-Options",
    value: "nosniff",
  },
  {
    key: "Referrer-Policy",
    value: "origin-when-cross-origin",
  },
  {
    key: "Permissions-Policy",
    value: "camera=(), microphone=(), geolocation=()",
  },
];
```

## 成果物

1. **セキュリティ監査レポート**

   - 発見された脆弱性のリスト
   - 修正内容の記録
   - 残存リスクの文書化

2. **セキュリティチェックリスト**

   - 全項目の確認結果
   - 未対応項目の理由

3. **修正コミット**

   - 発見された脆弱性の修正
   - テストコードの追加

## 推定時間

- RLS 監査: 1 日
- 認証・認可確認: 1 日
- 入力検証確認: 0.5 日
- 機密情報保護確認: 0.5 日
- 脆弱性スキャン・修正: 1 日
- ドキュメント作成: 0.5 日

**合計**: 4.5 日

## 次のステップ

セキュリティ監査完了後:

1. E2E テスト拡充プラン
2. パフォーマンス最適化プラン
3. 本番環境構築プラン