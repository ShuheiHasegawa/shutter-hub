---
name: QRコードチェックインシステム実装
overview: 撮影会スロットごとにQRコードを生成し、参加者がスキャンすることで入退場を記録するチェックインシステムを実装します。シンプルで効率的な設計を重視し、2回目のスキャンで退場記録も可能にします。
todos:
  - id: db-schema
    content: データベーススキーマ変更（checked_in_at, checked_out_at追加）
    status: pending
  - id: type-update
    content: Booking型定義の更新
    status: pending
    dependencies:
      - db-schema
  - id: server-action
    content: チェックインServer Action実装
    status: pending
    dependencies:
      - type-update
  - id: checkin-page
    content: チェックインページ実装
    status: pending
    dependencies:
      - server-action
  - id: qr-component
    content: QRコード生成コンポーネント実装
    status: pending
  - id: organizer-ui
    content: 運営者向けチェックイン管理UI実装
    status: pending
    dependencies:
      - qr-component
      - server-action
  - id: statistics
    content: チェックイン統計表示機能
    status: pending
    dependencies:
      - organizer-ui
  - id: participant-ui
    content: 参加者向けチェックイン状態表示
    status: pending
    dependencies:
      - server-action
  - id: certificate
    content: 入場証明書発行機能実装
    status: pending
    dependencies:
      - checkin-page
  - id: testing
    content: E2Eテスト実装
    status: pending
    dependencies:
      - checkin-page
      - organizer-ui
      - certificate
---

# QRコードチェックインシステム実装計画

## 実装仕様

### 基本フロー

1. 撮影会主催者（運営者・カメラマン・モデル）が撮影会詳細ページでスロットごとのQRコードを表示・印刷
2. 参加者がQRコードをスキャン（スマホのカメラアプリで可能）
3. 自動的にチェックインページに遷移し、入場時刻を記録
4. 2回目のスキャンで退場時刻を記録
5. チェックイン完了後、デジタル入場証をダウンロード可能（SNS共有目的）

## 実装ステップ

### 1. データベーススキーマ変更

[`supabase/migrations/YYYYMMDDHHMMSS_add_checkin_to_bookings.sql`](supabase/migrations/)

```sql
-- bookingsテーブルにチェックイン情報を追加
ALTER TABLE bookings 
ADD COLUMN checked_in_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN checked_out_at TIMESTAMP WITH TIME ZONE;

-- インデックス追加（検索パフォーマンス向上）
CREATE INDEX idx_bookings_checked_in_at ON bookings(checked_in_at);
CREATE INDEX idx_bookings_slot_id ON bookings(slot_id);

COMMENT ON COLUMN bookings.checked_in_at IS '入場時刻（QRスキャン1回目）';
COMMENT ON COLUMN bookings.checked_out_at IS '退場時刻（QRスキャン2回目）';
```



### 2. 型定義の更新

[`src/types/database.ts`](src/types/database.ts) のBooking型に以下を追加:

```typescript
export interface Booking {
  // ... 既存フィールド
  checked_in_at?: string | null;
  checked_out_at?: string | null;
}
```



### 3. チェックイン処理のServer Action

[`src/app/actions/checkin.ts`](src/app/actions/) - 新規作成

```typescript
'use server';

export async function checkInToSlot(slotId: string) {
  // 1. 認証確認
  // 2. 予約の取得（slot_id + user_id）
  // 3. チェックイン状態の判定
  //    - checked_in_at が null → 入場記録
  //    - checked_in_at あり、checked_out_at が null → 退場記録
  //    - 両方あり → エラー（既に完了）
  // 4. タイムスタンプを更新
  // 5. 成功メッセージを返す
}

export async function getCheckInStatus(slotId: string) {
  // スロットの全予約のチェックイン状況を取得
  // 運営者用の統計表示に使用
}
```



### 4. チェックインページ

[`src/app/[locale]/checkin/[slotId]/page.tsx`](src/app/[locale]/checkin/) - 新規作成

- URLから`slotId`を取得
- 自動的に`checkInToSlot`を実行
- 結果に応じたメッセージ表示:
- ✅ 入場完了
- ✅ 退場完了
- ❌ 予約が見つかりません
- ❌ 既に完了しています
- スロット情報（時間、場所）の表示

### 5. QRコード生成コンポーネント

[`src/components/qr-code/SlotQRCode.tsx`](src/components/qr-code/) - 新規作成

```bash
npm install qrcode.react
```



- スロットIDからチェックインURLを生成: `${BASE_URL}/checkin/${slotId}`
- QRCodeコンポーネントでQRコードを表示
- 印刷用のスタイル適用
- スロット情報（時間、枠番号）を併記

### 6. 運営者向けUI拡張

[`src/components/photo-sessions/CheckInManagement.tsx`](src/components/photo-sessions/) - 新規作成

- スロット一覧とQRコード表示
- 各スロットのチェックイン統計:
- 予約数 / チェックイン数 / チェックアウト数
- 印刷ボタン（全スロットのQRコードを一括印刷）

[`src/app/[locale]/photo-sessions/[id]/page.tsx`](src/app/[locale]/photo-sessions/[id]/page.tsx)

- 撮影会主催者（`organizer_id`と一致するユーザー）のみ表示されるタブ「チェックイン管理」を追加
- CheckInManagementコンポーネントを配置
- `user_type`ではなく`organizer_id`で判定するため、モデル・カメラマンが作成した撮影会でも利用可能

### 7. 参加者向けUI（予約詳細）

[`src/components/bookings/BookingCheckInStatus.tsx`](src/components/bookings/) - 新規作成

- 自分の予約のチェックイン状態を表示
- 未チェックイン / チェックイン済み / 完了 のバッジ
- チェックイン時刻、チェックアウト時刻の表示

## より効率的な代替案・追加機能の提案

### 提案1: 自動チェックアウト機能

**課題**: 退場時に再度スキャンを忘れる可能性がある**解決策**:

- スロット終了時刻の30分後に自動的に`checked_out_at`を記録
- または、次のスロットの開始時刻に自動チェックアウト

**実装**:

```typescript
// Supabase Edge Functionまたはcron job
async function autoCheckOut() {
  // 終了時刻を過ぎたスロットで
  // checked_in_at があり checked_out_at が null の予約を
  // 自動的にチェックアウト
}
```



### 提案2: リアルタイム参加者カウント

**メリット**: 運営者が現在の入場者数をリアルタイムで把握できる**実装**:

- Supabase Realtimeで`bookings`テーブルの変更を購読
- チェックイン数/チェックアウト数を動的に更新
- ダッシュボードに「現在の参加者数」を表示

### 提案3: NFCタッチ対応

**より効率的**: QRスキャンより高速**実装方法**:

- Web NFC API（Android Chromeで利用可能）
- NFCタグに`checkin/{slotId}`のURLを書き込む
- スマホをタッチするだけでチェックイン
```typescript
// NFCタグへの書き込み（運営者用ツール）
const ndef = new NDEFReader();
await ndef.write({
  records: [{ recordType: "url", data: checkinUrl }]
});
```




### 提案4: 入場証明書の発行（Phase 2で実装）

**追加価値**: 参加記念、SNS共有、運営管理の強化**機能**:

- チェックイン完了後、デジタル入場証をダウンロード可能
- 画像生成（撮影会情報、デザイン性のある背景、タイムスタンプ）
- SNSでの共有を想定した縦長デザイン（Instagram Story/Twitter対応）
- 「#ShutterHub」などのハッシュタグを含めてブランディング強化
- 後からの確認・証明にも使用可能

**実装方法**:

```typescript
// HTML to Canvasライブラリを使用
import html2canvas from 'html2canvas';

// デザイン性のあるHTMLテンプレート
<div className="certificate">
  <h1>入場証明書</h1>
  <p>{session.title}</p>
  <p>{checkedInAt}</p>
  <QRCode value={certificateId} />
  <p>#ShutterHub</p>
</div>

// 画像として保存
const canvas = await html2canvas(element);
canvas.toBlob((blob) => {
  saveAs(blob, 'certificate.png');
});
```



## 実装の優先順位

### Phase 1（必須機能）

1. データベーススキーマ変更
2. チェックインServer Action
3. チェックインページ
4. QRコード生成コンポーネント
5. 運営者向けUI（QRコード表示）

### Phase 2（便利機能）

6. チェックイン統計表示
7. 参加者向けチェックイン状態表示
8. 印刷用スタイル
9. **入場証明書発行機能（SNS共有目的）**

- デザイン性のある証明書テンプレート作成
- 画像生成機能（html2canvas）
- ダウンロード・共有機能
- Instagram Story/Twitter最適化

### Phase 3（拡張機能・将来実装）

- 自動チェックアウト
- リアルタイム参加者カウント
- NFCタッチ対応
- 入場証明書のデザインテンプレート追加（テーマ選択機能）

## 技術スタック

- **QRコード生成**: `qrcode.react` (軽量、React対応)
- **チェックイン処理**: Server Actions（Next.js 14 App Router）
- **リアルタイム更新**: Supabase Realtime（Phase 2以降）
- **印刷対応**: CSS `@media print`
- **画像生成**: `html2canvas` (証明書のPNG/JPEG生成)
- **ファイル保存**: `file-saver` (画像ダウンロード)

## セキュリティ考慮事項

1. **予約確認**: チェックインは必ず予約の存在を確認
2. **認証必須**: ログインユーザーのみチェックイン可能
3. **スロット検証**: スロットIDの正当性チェック
4. **重複防止**: 同じユーザーが複数回チェックインできないように制御
5. **RLSポリシー**: Supabaseのセキュリティを活用

## テスト項目

- [ ] QRコード生成が正しく動作するか
- [ ] チェックインページが正しくスロット情報を取得できるか
- [ ] 初回スキャンで入場時刻が記録されるか
- [ ] 2回目スキャンで退場時刻が記録されるか
- [ ] 予約がない場合にエラーメッセージが表示されるか
- [ ] 既にチェックアウト済みの場合にエラーメッセージが表示されるか
- [ ] 撮影会主催者（organizer_id）がチェックイン統計を確認できるか
- [ ] モデル・カメラマンが作成した撮影会でもQRコード機能が使えるか
- [ ] 入場証明書が正しく生成・ダウンロードできるか