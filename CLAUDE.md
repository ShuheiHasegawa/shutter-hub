# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

**Note**: This file is automatically generated from `.cursor/rules/core/*.mdc` files.
To modify the content, edit the source files in `.cursor/rules/core/` and run `.cursor/rules/sync-to-claude.sh`.

---



## Development Commands
```bash
# Development
npm run dev              # Start development server with Turbopack

# Building and Production
npm run build           # Build for production
npm run start           # Start production server

# Code Quality
npm run lint            # Run ESLint
npm run format          # Format code with Prettier
npm run type-check      # TypeScript type checking

# Database
npm run migrate         # Run database migrations (via MCP)

# Testing
npm run test:e2e        # Run Playwright E2E tests
```

## Git Workflow
```bash
# After implementing features
git add .
git commit -m "feat: [実装内容の日本語要約]"
git push origin main
```



## Technology Stack
- **Framework**: Next.js 15.3.2 with App Router
- **Language**: TypeScript (strict mode)
- **UI**: Shadcn/ui components (Radix UI based)
- **Styling**: Tailwind CSS
- **Backend**: Supabase (Auth, PostgreSQL, Storage, Realtime)
- **Payments**: Stripe
- **I18n**: next-intl (ja/en)

## Project Structure
```
src/
├── app/[locale]/          # Internationalized routes
│   ├── (public)/         # Public photobook pages
│   ├── admin/            # Admin dashboard
│   ├── auth/             # Authentication
│   ├── bookings/         # Booking management
│   ├── instant/          # Instant photo requests
│   ├── messages/         # Messaging system
│   ├── photo-sessions/   # Photo session management
│   └── photobooks/       # Digital photobooks
├── components/           # React components
├── lib/                 # Utilities and configs
└── types/               # TypeScript definitions
```

## Key Design Patterns

### 1. Server Components First
- Use Server Components by default
- Client Components only when necessary (user interaction, browser APIs)
- Server Actions for data mutations

### 2. Type Safety
- 100% TypeScript coverage
- No `any` types allowed
- Next.js 15 page props must be Promise types:
```typescript
interface PageProps {
  params: Promise<{ id: string; locale: string }>;
  searchParams: Promise<{ [key: string]: string }>;
}
```

## Database Schema
- 35+ tables with Row Level Security (RLS)
- Complex relationships for users, sessions, bookings, payments
- Real-time features via Supabase
- Migrations in `supabase/migrations/`



## UI/UX Protection Rules
**CRITICAL**: Never modify layouts, designs, colors, spacing, or any visual elements without explicit user request. Only bug fixes and accessibility improvements are allowed.

## Internationalization
All user-facing text must use translation keys. No hardcoded Japanese/English text allowed:
```typescript
// ❌ Bad
<Button>予約する</Button>

// ✅ Good
const t = useTranslations('booking');
<Button>{t('reserve')}</Button>
```

## Date/Time Formatting
Use provided utility functions, NOT toLocaleString():
```typescript
import { formatDateLocalized, formatTimeLocalized } from '@/lib/utils/date';

// ✅ Correct
formatDateLocalized(new Date(date), 'ja', 'long')

// ❌ Wrong - causes errors
<DateTime value={date} format="date-long" />
```

## TODO Management
After implementing any feature:
1. Update `.cursor/rules/dev-rules/todo.mdc`
2. Mark completed tasks: `[ ]` → `[x]`
3. Record implementation time and technical achievements
4. Commit and push changes

## Commit Rules
- Use Japanese commit messages
- Follow conventional commits format:
```
feat: 新機能追加の要約
fix: バグ修正の内容
docs: ドキュメント更新
refactor: リファクタリング内容
```

## Dependency Management
- Check compatibility before adding packages
- Use `--legacy-peer-deps` for peer dependency conflicts
- Always run `npm run build` after changes
- Update `.npmrc` if needed

## Critical Warnings

1. **UI/UX Changes**: Absolutely forbidden without explicit request
2. **Hardcoded Text**: All text must use i18n keys
3. **DateTime Component**: Do NOT use - causes "Invalid time value" errors
4. **Any Types**: Forbidden - use `unknown` instead
5. **Console Logs**: Remove before committing

## Testing
- E2E tests with Playwright
- Run before major changes: `npm run test:e2e`
- Test files in `/tests/e2e/`

## Useful Resources
- Development rules: `.cursor/rules/dev-rules/development.mdc`
- UI guide: `.cursor/rules/dev-rules/ui-guide.mdc`
- TODO list: `.cursor/rules/dev-rules/todo.mdc`
- Feature docs: `.cursor/rules/dev-rules/[feature].mdc`



For large features, use the spec-based development approach:

## Step 1: Create Minimal Spec
Create a minimal specification file in `.cursor/plans/` or provide it directly:

```
新しい機能: [機能名]
基本的な要件: [最小限の要件]
```

## Step 2: Deep Interview
Ask in-depth questions about:
- **Technical Implementation**: Integration with existing systems, performance requirements, error handling, data consistency, security, scalability
- **UI/UX Details**: User journey, edge cases, accessibility, responsive design, animations, error states
- **Business Logic**: Business rules, exception handling, data validation, workflow branching, notification timing
- **Trade-offs**: Complexity vs completeness, performance vs development speed, flexibility vs simplicity, future extensibility vs current requirements

**Important**: Ask non-obvious questions. Don't ask about things that can be determined from existing code (e.g., "Will we use React?" when the project already uses React).

## Step 3: Generate Specification
After the interview is complete, generate a comprehensive specification document including:
- Functional and non-functional requirements
- Technical specifications (database design, API design, UI/UX design)
- Implementation plan with step-by-step procedures
- Important notes and constraints

Save the specification to `.cursor/plans/[feature-name]_spec_[timestamp].md`

## Step 4: Implementation in New Session
Use the generated specification to implement the feature in a new session.

## Example Usage in Claude Code

```
I want to build a new feature: User notification system
Basic requirements: Support both email and push notifications

Please read this CLAUDE.md file and interview me in detail about technical implementation, UI/UX, concerns, tradeoffs, etc.
Make sure the questions are not obvious and be very in-depth.
Continue interviewing until it's complete, then write the spec to a file.
```

## Example Usage in Cursor

```
@spec-interview.md .cursor/plans/notification-system.md
```

## Interview Checklist
When conducting the interview, ensure you cover:
- [ ] Technical implementation details (5+ deep questions)
- [ ] UI/UX details (3+ questions)
- [ ] Business logic clarification (3+ questions)
- [ ] Trade-off considerations (2+ alternative options with pros/cons)
- [ ] Edge cases (3+ cases)
- [ ] Security and permissions (2+ questions)
- [ ] Performance requirements (2+ questions)
- [ ] Future extensibility (1+ question)

## Question Examples (Non-Obvious)

❌ **Avoid obvious questions:**
- "Will we use React?" (project already uses React)
- "Will we use Supabase?" (already using Supabase)

✅ **Ask deep questions:**
- "What's the expected concurrent access for this feature? Do we need rate limiting?"
- "How much information should we show users when errors occur? Are there security concerns?"
- "Will this feature be extended to other user types (model, photographer) in the future?"
- "Do we need transaction processing to maintain data consistency?"
- "What are the performance targets for this feature? (response time, throughput)"
- "How should users recover from mistakes? Is there an undo mechanism?"

**Reference**: See `.cursor/commands/spec-interview.md` for detailed workflow, question templates, and best practices.

