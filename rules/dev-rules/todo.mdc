---
description: 
globs: 
alwaysApply: true
---
まず、このファイルを参照したら、このファイル名を発言すること

## タスク管理

### タスク管理の方法

1. [Todo.md](mdc:Todo.md) ファイルを使用してタスクを管理してください。
2. 各タスクは以下の形式で記録：

   ```markdown
   - [ ] タスクの説明
     - 詳細な手順や注意点
     - 依存関係
     - 見積時間
   ```

3. タスクのステータス管理：

   - [ ] 未着手
   - [x] 完了
   - [~] 進行中
   - [!] 問題あり

4. タスクの優先順位付け：
   - 🔴 緊急
   - 🟡 重要
   - 🟢 通常
   - ⚪ 低優先

### タスクの更新ルール

1. タスクの追加

   - 新しい要件や問題が発見された場合
   - 依存関係が明確になった場合
   - リファクタリングが必要な場合

2. タスクの更新

   - 進捗状況の変更
   - 新しい情報の追加
   - 依存関係の変更

3. タスクの完了
   - 実装の完了
   - テストの完了
   - レビューの完了

### タスクの追跡

1. 日次更新

   - 進捗状況の確認
   - ブロッカーの特定
   - 次のアクションの決定

2. 週次レビュー

   - 完了タスクの確認
   - 未完了タスクの再評価
   - 新規タスクの追加

3. 月次振り返り
   - パフォーマンスの評価
   - 改善点の特定
   - 次のマイルストーンの設定

## 開発タスク（ShutterHub v2）

### フェーズ1（MVP）
- [x] プロジェクト初期設定
- [x] マイグレーションファイル一元化とMCP連携自動化
  - [x] 統合マイグレーションファイル作成（002_complete_schema.sql）
  - [x] MCPツールでSupabaseプロジェクトに適用
  - [x] 古いマイグレーションファイル削除
  - [x] 開発ルールに自動化プロセス追加
  - [x] positionカラム名修正（queue_position）
- [x] 認証システム実装（`auth.mdc`参照）
  - [x] Google OAuth認証
  - [x] X (Twitter) OAuth認証
  - [x] Discord OAuth認証
  - [x] プロフィール作成・編集機能（Shadcn/ui対応）
  - [x] 認証ガード機能
  - [x] セッション管理
- [x] 基本的なユーザー管理
- [x] 撮影会（PhotoSession）作成・管理機能
  - [x] 撮影会CRUD操作ライブラリ
  - [x] 撮影会作成・編集フォーム（Shadcn/ui）
  - [x] 撮影会カードコンポーネント
  - [x] 撮影会一覧・検索・フィルター機能
  - [x] 日時・場所・料金管理
  - [x] 公開/非公開設定
  - [x] **画像アップロード機能（Supabase Storage連携）**
    - [x] Storageバケット作成・設定（MCP自動化）
    - [x] 画像アップロード・削除ライブラリ
    - [x] ImageUploadコンポーネント（ドラッグ&ドロップ対応）
    - [x] 撮影会フォームに画像アップロード統合
    - [x] 画像最適化・サムネイル生成
    - [x] 多言語化対応
  - [x] **撮影会作成フォーム拡張**
    - [x] 予約方式選択機能（先着順・抽選・管理抽選・優先予約）
    - [x] BookingTypeSelectorコンポーネント
    - [x] BookingSettingsFormコンポーネント
    - [x] ImageUploadコンポーネント（ドラッグ&ドロップ対応）
    - [x] 各予約方式の詳細設定フォーム
    - [x] 型定義拡張（BookingType、BookingSettings）
    - [x] データベースマイグレーション（booking_typeフィールド追加）
    - [x] RadioGroupコンポーネント追加
    - [x] 多言語化対応（日本語・英語翻訳追加）
  - [x] **撮影会一覧サイドバー統合**
    - [x] PhotoSessionsSidebarコンポーネント作成
    - [x] 高度なフィルタリング機能（キーワード・場所・日時・料金・参加者数・予約方式）
    - [x] フィルター状態管理とクリア機能
    - [x] レスポンシブ対応（モバイル・デスクトップ）
    - [x] PhotoSessionListコンポーネント拡張
    - [x] サイドバー連携フィルタリング実装
    - [x] 多言語化対応
- [x] 多言語化対応（日本語/英語）
  - [x] next-intl統合
  - [x] 全コンポーネント多言語化
  - [x] 日付・時刻フォーマット多言語対応
- [x] **撮影会予約システム実装**（`prompts-booking.mdc`参照）
  - [x] 🔴 先着順予約システム
  - [x] 🟡 抽選予約システム
    - [x] 抽選撮影会Server Actions（作成・エントリー・実行・取得）
    - [x] PhotoSessionLotteryEntryコンポーネント
    - [x] エントリー期間管理・バリデーション
    - [x] 抽選ステータス管理
    - [x] 多言語化対応（日本語・英語翻訳）
  - [x] 🟡 管理抽選システム（開催者選出）
    - [x] データベース設計（管理抽選セッション・応募・選出履歴）
    - [x] Server Actions（作成・応募・選出・取り消し・ステータス管理）
    - [x] AdminLotteryEntryコンポーネント（応募フォーム）
    - [x] AdminLotteryManagementコンポーネント（管理画面）
    - [x] 応募者一覧・検索・フィルタリング機能
    - [x] 一括選出・個別選出機能
    - [x] 選出履歴・理由記録
    - [x] 多言語化対応（日本語・英語翻訳）
  - [x] 🟡 **優先予約システム（カスタマイズ可能）**
    - [x] データベース設計（優先予約設定・チケット・ランク）
    - [x] ユーザーランクシステム（自動昇格・手動調整）
    - [x] 優先チケット管理（付与・使用・期限管理）
    - [x] 予約制御ロジック（4パターン対応）
    - [x] 開催者向け管理画面（設定・チケット管理）
    - [x] ユーザー向けUI（優先予約フォーム・ランク表示）
    - [x] 多言語化対応
  - [x] 🟢 キャンセル待ちシステム
    - [x] データベース設計（キャンセル待ち・設定・履歴・通知）
    - [x] 自動繰り上げ機能（ストアドプロシージャ）
    - [x] 期限付き繰り上げ当選システム
    - [x] キャンセル待ち管理UI（フォーム・設定）
    - [x] 通知システム基盤
    - [x] 多言語化対応
- [x] 🟡 **スロット制撮影会システム**
  - [x] データベース設計（photo_session_slotsテーブル・ストアドプロシージャ）
  - [x] 時間枠細分化管理機能
  - [x] 枠ごとの個別設定（時間・料金・人数・衣装・割引）
  - [x] 自動時間計算機能
  - [x] 個別休憩時間設定（お昼休憩等の長時間対応）
  - [x] 枠ごとの衣装画像アップロード機能
  - [x] 割引システム（パーセンテージ・固定金額）
  - [x] PhotoSessionSlotFormコンポーネント（スロット管理UI）
  - [x] PhotoSessionSlotCardコンポーネント（スロット表示・予約UI）
  - [x] 撮影会フォームへのスロット機能統合
  - [x] 型定義・ライブラリ関数完備
  - [x] 多言語化対応（日本語・英語）
  - [x] 要件定義更新
- [x] 🟢 **検索・フィルタリング機能**
  - [x] AdvancedSearchコンポーネント（高度な検索UI）
  - [x] 詳細フィルター（キーワード・場所・日時・料金・参加者数・予約方式）
  - [x] ソート機能（日時・料金・作成日・参加者数順）
  - [x] リアルタイム検索結果表示
  - [x] 空きありフィルター
  - [x] 多言語化対応（日本語・英語）
  - [x] レスポンシブデザイン

### フェーズ2（拡張機能）
- [x] 🟢 **評価・レビューシステム**
  - [x] データベース設計（レビュー・評価・統計）
  - [x] 撮影会レビュー機能（参加者→主催者・撮影会）
  - [x] ユーザーレビュー機能（相互評価）
  - [x] 5段階評価システム
  - [x] レビュー表示・フィルタリング（基盤）
  - [x] 評価統計・ランキング（基盤）
  - [x] 不適切レビュー報告・管理機能
  - [x] 多言語化対応
  - [x] レビュー一覧コンポーネント
  - [x] 評価統計表示コンポーネント
  - [x] **撮影会詳細ページへの統合**
    - [x] PhotoSessionReviewWrapperコンポーネント作成
    - [x] 参加者のみレビュー投稿可能な権限制御
    - [x] レビュー投稿後の自動リフレッシュ機能
    - [x] スクロール機能とUX改善
    - [x] 多言語化対応
  - [x] **ユーザープロフィールページへの統合**
    - [x] UserProfileCardコンポーネント作成（基本情報・アバター表示）
    - [x] UserRatingStatsコンポーネント作成（主催者・参加者評価統計）
    - [x] UserReviewListコンポーネント作成（受け取ったレビュー一覧）
    - [x] 活動統計表示（主催・参加撮影会数、レビュー数）
    - [x] タブ式UI（レビュー・撮影会・活動履歴）
    - [x] 多言語化対応
- [ ] 高度な予約システム
- [ ] コミュニケーション機能
- [ ] 決済機能

### フェーズ3（高度な機能・差別化）
- [ ] **🚀 即座撮影リクエスト機能**（`instant-photo-request.mdc`参照）
  - [ ] 🔴 ゲスト機能（認証不要）
  - [ ] 🔴 位置情報ベースマッチング
  - [ ] 🔴 リアルタイム通知システム
  - [ ] 🟡 カメラマンオンライン状態管理
  - [ ] 🟡 即座決済システム
  - [ ] 🟡 写真自動配信
  - [ ] 🟢 多言語対応（外国人観光客向け）
  - [ ] 🟢 観光地パートナーシップ
- [ ] クラウドファンディング
- [ ] ポートフォリオ機能
- [ ] AI機能

## 重要事項

1. 機能の実装後に、毎回 @todo.md を確認＆更新をしてください。
2. 私が言わなくても中身は随時更新するようにしてください。更新しないと私が解雇されます。あなたの責任になってしまいます。
3. 機能は増やしても構いません。ただ、最初から機能を増やしすぎないでください。
4. **複雑な機能実装時は専門プロンプトファイルを必ず参照してください**
5. **即座撮影リクエスト機能は一般層獲得の重要な差別化機能です**

# ShutterHub v2 開発タスク管理

## 🎯 **現在の進捗状況**

### ✅ **完了済み**
- [x] **t0-001**: プロジェクト設計書の整理・統合（11ファイル→7ファイル）
- [x] **t0-002**: 技術スタック更新（Ant Design → Shadcn/ui）
- [x] **t0-003**: 複雑な予約システム用プロンプトテンプレート作成
- [x] **t0-004**: 認証システム拡張（複数OAuth対応、Shadcn/uiプロフィール管理）
- [x] **t0-005**: 撮影会管理機能実装（CRUD、検索、フィルタリング）
- [x] **t0-006**: 先着順予約システム実装（リアルタイム在庫管理）
- [x] **t0-007**: 多言語化対応（ja/en）
- [x] **t0-008**: スロット制撮影会システム実装（データベース、ライブラリ、UI）
- [x] **t0-009**: スロット制撮影会フォームUI改善（動的枠追加、自動入力機能）
- [x] **t0-010**: スロット制入力の大幅改善（時間ベース入力、画像効率化）

### 🔄 **進行中**
- [ ] **t0-011**: スロット制予約システムの統合テスト

### 📋 **次のタスク**
- [ ] **t0-012**: 抽選予約システム実装
- [ ] **t0-013**: 優先予約システム実装
- [ ] **t0-014**: 管理抽選システム実装
- [ ] **t0-015**: キャンセル待ちシステム実装
- [ ] **t0-016**: レビュー・評価システム実装
- [ ] **t0-017**: 通知システム実装
- [ ] **t0-018**: 決済システム統合
- [ ] **t0-019**: 管理者ダッシュボード実装
- [ ] **t0-020**: パフォーマンス最適化
- [ ] **t0-021**: セキュリティ監査・テスト

## 📝 **最新の更新内容**

### **t0-010: スロット制入力の大幅改善** ✅
**実装内容:**
- **時間ベース入力**: 日付は別入力、時間は時:分のみで簡素化
- **撮影時間による自動計算**: 開始時刻 + 撮影時間 = 終了時刻の自動算出
- **連続スロット自動生成**: 同じ撮影時間で後続スロットも自動計算
- **衣装画像の効率化**: SHA-256ハッシュによる重複排除とキャッシュ機能
- **設定コピー機能**: 上のスロットの設定を一括コピー

**技術的改善:**
- 時間入力をdatetime-localからtime型に変更
- 撮影時間（分）による終了時刻の自動計算
- 画像ハッシュ値計算とキャッシュシステム
- データベース画像管理テーブルの追加
- 使用回数トラッキングによる自動削除

**ファイル変更:**
- `src/components/photo-sessions/PhotoSessionSlotForm.tsx`: 時間ベース入力に完全リファクタリング
- `src/types/photo-session.ts`: 画像ハッシュフィールド追加
- `supabase/migrations/20241201000009_add_costume_image_hash.sql`: 画像管理システム追加
- `src/components/photo-sessions/PhotoSessionForm.tsx`: baseDate対応

## 🎨 **UI/UX改善点**

### **スロット管理フォーム**
- ✅ 時間ベース入力（時:分形式）
- ✅ 撮影時間による終了時刻自動計算
- ✅ 連続スロットの自動時間設定
- ✅ 衣装画像の重複排除（ハッシュベース）
- ✅ 設定コピー機能（上のスロットから）
- ✅ リアルタイム割引価格計算
- ✅ 動的な枠の追加・削除
- ✅ バリデーション機能

### **次の改善予定**
- [ ] スロット間の時間重複チェック
- [ ] 一括設定機能（全スロットに同じ設定を適用）
- [ ] テンプレート機能（よく使う設定の保存・読み込み）
- [ ] プレビュー機能（ユーザー視点での表示確認）
- [ ] 画像圧縮・最適化機能

## 🔧 **技術的な課題と解決**

### **解決済み**
- ✅ 時間入力の複雑性 → 時:分形式に簡素化
- ✅ 撮影時間による自動計算システム
- ✅ 画像重複問題 → ハッシュベース管理
- ✅ 設定入力の効率化 → コピー機能
- ✅ TypeScript型安全性の向上

### **今後の課題**
- [ ] スロット予約の競合状態処理
- [ ] 大量スロットでのパフォーマンス最適化
- [ ] モバイル対応の改善
- [ ] 画像ストレージの最適化

## 📊 **プロジェクト統計**

- **総ファイル数**: 150+ ファイル
- **実装済み機能**: 10/21 (48%)
- **コンポーネント数**: 50+ コンポーネント
- **多言語対応**: 日本語・英語
- **データベーステーブル**: 15+ テーブル

---

**最終更新**: 2024年12月1日
**次回作業**: スロット制予約システムの統合テスト
